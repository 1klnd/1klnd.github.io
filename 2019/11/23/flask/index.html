<!doctype html>
<html lang="zh"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta><title>flask 开发 - 饱食终日，无所事事</title><link rel="manifest" href="/manifest.json"><meta name="application-name" content="饱食终日，无所事事"><meta name="msapplication-TileImage" content="/img/favicon.svg"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="饱食终日，无所事事"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta description="使用 python3，linux"><meta property="og:type" content="blog"><meta property="og:title" content="flask 开发"><meta property="og:url" content="http://example.com/2019/11/23/flask/"><meta property="og:site_name" content="饱食终日，无所事事"><meta property="og:description" content="使用 python3，linux"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="http://example.com/img/og_image.png"><meta property="article:published_time" content="2019-11-23T13:53:07.000Z"><meta property="article:modified_time" content="2020-07-07T14:12:52.176Z"><meta property="article:author" content="lll"><meta property="article:tag" content="flask"><meta property="article:tag" content="python"><meta property="twitter:card" content="summary"><meta property="twitter:image" content="/img/og_image.png"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"http://example.com/2019/11/23/flask/"},"headline":"饱食终日，无所事事","image":["http://example.com/img/og_image.png"],"datePublished":"2019-11-23T13:53:07.000Z","dateModified":"2020-07-07T14:12:52.176Z","author":{"@type":"Person","name":"lll"},"description":"使用 python3，linux"}</script><link rel="canonical" href="http://example.com/2019/11/23/flask/"><link rel="icon" href="/img/favicon.svg"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.12.0/css/all.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@9.12.0/styles/atom-one-light.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link rel="stylesheet" href="/css/default.css"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/css/justifiedGallery.min.css"><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/pace-js@1.0.2/pace.min.js"></script><!--!--><!--!--><meta name="generator" content="Hexo 5.2.0"></head><body class="is-2-column"><nav class="navbar navbar-main"><div class="container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/"><img src="/img/logo.svg" alt="饱食终日，无所事事" height="28"></a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">Home</a><a class="navbar-item" href="/archives">Archives</a><a class="navbar-item" href="/categories">Categories</a><a class="navbar-item" href="/tags">Tags</a><a class="navbar-item" href="/about">About</a></div><div class="navbar-end"><a class="navbar-item is-hidden-tablet catalogue" title="目录" href="javascript:;"><i class="fas fa-list-ul"></i></a><a class="navbar-item search" title="搜索" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-8-widescreen"><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2019-11-23T13:53:07.000Z" title="2019-11-23T13:53:07.000Z">2019-11-23</time>发表</span><span class="level-item"><time dateTime="2020-07-07T14:12:52.176Z" title="2020-07-07T14:12:52.176Z">2020-07-07</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/python/">python</a></span><span class="level-item">2 小时读完 (大约14045个字)</span></div></div><h1 class="title is-3 is-size-4-mobile">flask 开发</h1><div class="content"><p>使用 python3，linux</p>
<a id="more"></a>

<h1 id="Flask-简介"><a href="#Flask-简介" class="headerlink" title="Flask 简介"></a>Flask 简介</h1><h2 id="准备"><a href="#准备" class="headerlink" title="准备"></a>准备</h2><h3 id="创建应用目录"><a href="#创建应用目录" class="headerlink" title="创建应用目录"></a>创建应用目录</h3><p>git clone 现成的 git 仓库</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">git clone https:<span class="regexp">//gi</span>thub.com<span class="regexp">/miguelgrinberg/</span>flasky.git</span><br><span class="line">cd flasky</span><br><span class="line">git checkout <span class="number">1</span>a</span><br></pre></td></tr></table></figure>

<p>或者新建目录</p>
<figure class="highlight dos"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> flasky</span><br><span class="line"><span class="built_in">cd</span> flasky</span><br></pre></td></tr></table></figure>

<h3 id="准备虚拟环境"><a href="#准备虚拟环境" class="headerlink" title="准备虚拟环境"></a>准备虚拟环境</h3><p>使用venv的虚拟环境可以运行独立的解释器，安装独立的包。</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apt</span> <span class="string">install python3-venv</span></span><br><span class="line"><span class="comment"># 在flasky目录下</span></span><br><span class="line"><span class="attr">python3</span> <span class="string">-m venv venv</span></span><br></pre></td></tr></table></figure>

<p>激活虚拟环境</p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">source</span> venv<span class="regexp">/bin/</span>active</span><br></pre></td></tr></table></figure>

<p>完成虚拟环境中的工作后使用 <code>deactivate</code> 取消激活</p>
<h3 id="安装-flask"><a href="#安装-flask" class="headerlink" title="安装 flask"></a>安装 flask</h3><p>在虚拟环境中安装flask</p>
<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(venv) $ pip <span class="keyword">install</span> flask</span><br></pre></td></tr></table></figure>

<h2 id="应用的基本结构"><a href="#应用的基本结构" class="headerlink" title="应用的基本结构"></a>应用的基本结构</h2><h3 id="初始化"><a href="#初始化" class="headerlink" title="初始化"></a>初始化</h3><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask</span><br><span class="line">app = Flask(__name__)</span><br></pre></td></tr></table></figure>

<p>初始化 flask 应用需要创建一个 Flask类的对象，这个对象的初始化需要一个参数，即模块的<code>__name</code>。</p>
<p>web服务器通过WSGI(web server gateway interface) 协议把接收到的请求交给flask应用实例处理。</p>
<h3 id="路由和视图函数"><a href="#路由和视图函数" class="headerlink" title="路由和视图函数"></a>路由和视图函数</h3><p>客户端（例如浏览器）把请求发送给web服务器，服务器再把请求发给Flask应用实例，应用实例需要知道每个URL对应哪些代码，所以需要URL与python函数的映射关系，称为路由。。</p>
<p>定义路由的最简单方式是使用<code>app.route</code>装饰器</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@app.route(&#x27;/&#x27;)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">index</span>():</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;&lt;h1&gt;Hello,world!&lt;/h1&gt;&#x27;</span></span><br></pre></td></tr></table></figure>

<p>也可以使用<code>app.add_url_rule()</code>方法</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">index</span>():</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;&lt;h1&gt;Hello,world!&lt;/h1&gt;&#x27;</span></span><br><span class="line">app.add_url_rule(<span class="string">&#x27;/&#x27;</span>,<span class="string">&#x27;index&#x27;</span>,index)</span><br></pre></td></tr></table></figure>

<p><code>index()</code>称为视图函数，客户端访问<code>/</code>时会触发index函数，返回值称为响应，是客户端看到的内容。</p>
<p>Flask 的 URL中可以使用动态内容</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@app.route(&#x27;/user/&lt;name&gt;&#x27;)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">user</span>(<span class="params">name</span>):</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;Hello,&#123;&#125;!&#x27;</span>.format(name)</span><br></pre></td></tr></table></figure>

<p>URL中的动态部分（由app.route中的尖括号指定）会作为参数传入视图函数，默认是字符串类型，可以使用其他类型，形如<code>@app.route(&#39;/user/&lt;int:id&gt;&#39;)</code>，可食用的过滤器有 string,，int，float 和 path。</p>
<h3 id="完整应用实例"><a href="#完整应用实例" class="headerlink" title="完整应用实例"></a>完整应用实例</h3><p>hello.py</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask</span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(&#x27;/&#x27;)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">index</span>():</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;&lt;h1&gt;Hello,world!&lt;/h1&gt;&#x27;</span></span><br></pre></td></tr></table></figure>

<h3 id="Web开发服务器"><a href="#Web开发服务器" class="headerlink" title="Web开发服务器"></a>Web开发服务器</h3><p>通过 flask run 命令可以启动 flask自带的开发服务器，启动前需要设置FLASK_APP环境变量</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="builtin-name">export</span> <span class="attribute">FLASK_APP</span>=hello.py</span><br><span class="line">flask run</span><br></pre></td></tr></table></figure>

<p>也可以使用<code>app.run()</code>方法启动，在上面flask实例最后加上</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">	app.<span class="builtin-name">run</span>()</span><br></pre></td></tr></table></figure>

<p>开发服务器默认运行在5000端口</p>
<h3 id="调试模式"><a href="#调试模式" class="headerlink" title="调试模式"></a>调试模式</h3><p>启动调试模式后，开发服务器会加载重载器和调试器。重载器监测文件目录，发现改动时自动重启服务器；调试器在Web浏览器提供交互式追踪，也可以审查源码。</p>
<p>与上例对应，启动方式分两种</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="builtin-name">export</span> <span class="attribute">FLASK_APP</span>=hello.py</span><br><span class="line"><span class="builtin-name">export</span> <span class="attribute">FLASK_DEBUG</span>=1</span><br><span class="line">flask run</span><br></pre></td></tr></table></figure>

<p>或者</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">app.<span class="builtin-name">run</span>(<span class="attribute">debug</span>=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure>

<h3 id="命令行选项"><a href="#命令行选项" class="headerlink" title="命令行选项"></a>命令行选项</h3><figure class="highlight ada"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">flask <span class="comment">--help</span></span><br></pre></td></tr></table></figure>

<h3 id="请求-响应循环"><a href="#请求-响应循环" class="headerlink" title="请求-响应循环"></a>请求-响应循环</h3><h4 id="应用和请求上下文"><a href="#应用和请求上下文" class="headerlink" title="应用和请求上下文"></a>应用和请求上下文</h4><p>收到请求时flask需要访问一些对象才能完成对请求的处理，这时要像视图函数传入参数。为了避免传入不必要的参数，flask使用上下文临时把某些对象设置为全局可访问，例如request对象封装了用户发送的HTTP请求：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@app.route(&#x27;/&#x27;)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">index</span>():</span></span><br><span class="line">    user_agent = request.headers.get(<span class="string">&#x27;User-Agent&#x27;</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;&lt;p&gt;Your browser is &#123;&#125;&lt;/p&gt;&#x27;</span>.format(user_agent)</span><br></pre></td></tr></table></figure>

<p>上下文并不是全局变量，不同线程之间的访问是相互独立的。</p>
<p>Flask有请求上下文和应用上下文</p>
<table>
<thead>
<tr>
<th>变量</th>
<th>类型</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>current_app</td>
<td>应用上下文</td>
<td>当前的应用实例</td>
</tr>
<tr>
<td>g</td>
<td>应用上下文</td>
<td>处理请求时用作临时存储的对象，每次请求都会重置这个对象</td>
</tr>
<tr>
<td>request</td>
<td>请求上下文</td>
<td>请求对象，封装了客户端发送的HTTP请求的内容</td>
</tr>
<tr>
<td>session</td>
<td>请求上下文</td>
<td>用户会话，一个字典</td>
</tr>
</tbody></table>
<p>Flask 在分派请求之前激活上下文，请求处理完成后将其删除。获取上下文使用<code>app.appcontext()</code>方法。</p>
<h4 id="请求分派"><a href="#请求分派" class="headerlink" title="请求分派"></a>请求分派</h4><p>收到请求后，Flask 会在<code>app.url_map</code>中寻找处理URL对应使用的函数，</p>
<h4 id="request对象"><a href="#request对象" class="headerlink" title="request对象"></a>request对象</h4><p>封装收到的HTTP请求，含有以下常用属性和方法</p>
<figure class="highlight oxygene"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">form, args, values, cookies, headers, get_data(), get_form(), blueprint,endpoint, <span class="function"><span class="keyword">method</span>, <span class="title">scheme</span>, <span class="title">is_secure</span><span class="params">()</span>, <span class="title">host</span>, <span class="title">path</span>, <span class="title">Query_string</span>, <span class="title">full_path</span>, <span class="title">url</span>, <span class="title">base_url</span>, <span class="title">remote_addr</span>, <span class="title">environ</span></span></span><br></pre></td></tr></table></figure>

<h4 id="请求钩子"><a href="#请求钩子" class="headerlink" title="请求钩子"></a>请求钩子</h4><p>注册请求狗子在请求之前或者之后使用，通过装饰器实现，有四种。</p>
<ul>
<li>before_request，每次请求之前运行</li>
<li>before_first_request，在第一个请求之前运行</li>
<li>after_request，无异常抛出时在请求之后运行</li>
<li>teardown_request，即使有异常抛出也会在请求之后执行</li>
</ul>
<p>请求钩子和视图函数之间一般使用 g 对象共享数据。</p>
<h4 id="response对象"><a href="#response对象" class="headerlink" title="response对象"></a>response对象</h4><p>响应不但包括返回的字符串，还有请求头和HTTP状态码。Flask中有response对象可以处理返回的内容，包含以下常用属性和方法</p>
<figure class="highlight elm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="title">status_code</span>, headers, set_cookie(), delete_cookie(), content_length, content_<span class="keyword">type</span>, set_data(), get_data()</span><br></pre></td></tr></table></figure>

<p><code>redirect()</code>函数专门用来生成重定向响应</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">@app.route(<span class="string">&#x27;/index.php&#x27;</span>)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">indexphp</span><span class="params">()</span></span><span class="symbol">:</span></span><br><span class="line">	redirect(<span class="string">&#x27;/&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p><code>abort()</code>函数用于处理错误</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">@app.route(<span class="string">&#x27;/user/&lt;name&gt;&#x27;</span>)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">user</span><span class="params">()</span></span><span class="symbol">:</span></span><br><span class="line">	<span class="keyword">if</span> name != <span class="string">&#x27;admin&#x27;</span><span class="symbol">:</span></span><br><span class="line">		abort(<span class="number">403</span>)</span><br></pre></td></tr></table></figure>

<h3 id="Flask-扩展"><a href="#Flask-扩展" class="headerlink" title="Flask 扩展"></a>Flask 扩展</h3><p>Flask本身没有许多重要功能，比如数据库和身份验证，这些可以通过Flask扩展实现。</p>
<h2 id="模板"><a href="#模板" class="headerlink" title="模板"></a>模板</h2><h3 id="Jinja2-模板引擎"><a href="#Jinja2-模板引擎" class="headerlink" title="Jinja2 模板引擎"></a>Jinja2 模板引擎</h3><h4 id="渲染模板"><a href="#渲染模板" class="headerlink" title="渲染模板"></a>渲染模板</h4><p>默认情况下，Flask在应用目录的 templates 文件夹下寻找模板</p>
<p>templates/index.html：</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">&lt;h1&gt;</span><span class="attribute">Hello</span> World!&lt;/h<span class="number">1</span>&gt;</span><br></pre></td></tr></table></figure>

<p>templates/user.html：</p>
<figure class="highlight handlebars"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">h1</span>&gt;</span>Hello, </span><span class="template-variable">&#123;&#123; <span class="name">name</span> &#125;&#125;</span><span class="xml">!<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span></span><br></pre></td></tr></table></figure>

<p>hello.py：</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">from flask import Flask, render_template</span><br><span class="line"></span><br><span class="line">@app.route(<span class="string">&#x27;/&#x27;</span>)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">index</span><span class="params">()</span></span><span class="symbol">:</span></span><br><span class="line">	<span class="keyword">return</span> render_template(<span class="string">&#x27;index.html&#x27;</span>)</span><br><span class="line"></span><br><span class="line">@app.route(<span class="string">&#x27;/user/&lt;name&gt;&#x27;</span>)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">user</span><span class="params">(name)</span></span><span class="symbol">:</span></span><br><span class="line">	<span class="keyword">return</span> render_template(<span class="string">&#x27;user.html&#x27;</span>, name=name)</span><br></pre></td></tr></table></figure>

<h4 id="变量"><a href="#变量" class="headerlink" title="变量"></a>变量</h4><p>上面模板中使用的<code>&#123;&#123; name &#125;&#125;</code>结构表示一个变量，这是一种特殊的占位符，告诉模板这个位置的值从渲染模板时提供的数据获取。Jinja2能识别许多类型的变量，包括一些复杂的变量，比如列表、字典和对象。</p>
<figure class="highlight handlebars"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">p</span>&gt;</span> From a dictionary: </span><span class="template-variable">&#123;&#123; <span class="name">adict[&#x27;key&#x27;]</span> &#125;&#125;</span><span class="xml"> <span class="tag">&lt;<span class="name">\p</span>&gt;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">p</span>&gt;</span> From a list, with a variable index: </span><span class="template-variable">&#123;&#123; <span class="name">alist[variableint]</span> &#125;&#125;</span><span class="xml"> <span class="tag">&lt;<span class="name">\p</span>&gt;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">p</span>&gt;</span> From an object&#x27;s method: </span><span class="template-variable">&#123;&#123; <span class="name">aobj.amethod</span>() &#125;&#125;</span><span class="xml"> <span class="tag">&lt;<span class="name">\p</span>&gt;</span></span></span><br></pre></td></tr></table></figure>

<p>变量的值可以用过滤器修改，形如</p>
<figure class="highlight handlebars"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="template-variable">&#123;&#123; <span class="name">variable</span>|filter &#125;&#125;</span></span><br></pre></td></tr></table></figure>

<p>常用过滤器：</p>
<table>
<thead>
<tr>
<th>过滤器</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>safe</td>
<td>渲染时不转义(XSS)</td>
</tr>
<tr>
<td>captalize</td>
<td>首字母大写，其他小写</td>
</tr>
<tr>
<td>lower</td>
<td>全部转成小写</td>
</tr>
<tr>
<td>upper</td>
<td>全部转成大写|||</td>
</tr>
<tr>
<td>title</td>
<td>每个单词开头的字母大写</td>
</tr>
<tr>
<td>trim</td>
<td>去掉首尾的空格</td>
</tr>
<tr>
<td>striptags</td>
<td>去掉HTML标签</td>
</tr>
</tbody></table>
<h4 id="控制结构"><a href="#控制结构" class="headerlink" title="控制结构"></a>控制结构</h4><p>Jinja2提供了控制结构改变渲染流程。</p>
<p>条件判断：</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;% <span class="keyword">if</span><span class="built_in"> user </span>%&#125;</span><br><span class="line">	Hello, &#123;&#123;<span class="built_in"> user </span>&#125;&#125;!</span><br><span class="line">&#123;% <span class="keyword">else</span> %&#125;</span><br><span class="line">	Hello, Stranger!</span><br><span class="line">&#123;% endif %&#125;</span><br></pre></td></tr></table></figure>

<p>循环结构：</p>
<figure class="highlight django"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">ul</span>&gt;</span></span></span><br><span class="line"><span class="xml">	</span><span class="template-tag">&#123;% <span class="name"><span class="name">for</span></span> comment <span class="keyword">in</span> comments %&#125;</span></span><br><span class="line"><span class="xml">		<span class="tag">&lt;<span class="name">li</span>&gt;</span></span><span class="template-variable">&#123;&#123; comment &#125;&#125;</span><span class="xml"><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span></span><br><span class="line"><span class="xml">	</span><span class="template-tag">&#123;% <span class="name"><span class="name">endfor</span></span> %&#125;</span></span><br><span class="line"><span class="xml"><span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span></span><br></pre></td></tr></table></figure>

<p>Jinja2还支持宏，类似于函数：</p>
<figure class="highlight twig"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="template-tag">&#123;% <span class="name"><span class="keyword">macro</span></span> render_comment(comment) %&#125;</span></span><br><span class="line"><span class="xml">	<span class="tag">&lt;<span class="name">li</span>&gt;</span></span><span class="template-variable">&#123;&#123; comment &#125;&#125;</span><span class="xml"><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span></span><br><span class="line"><span class="template-tag">&#123;% <span class="name"><span class="keyword">endmacro</span></span> %&#125;</span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">ul</span>&gt;</span></span></span><br><span class="line"><span class="xml">	</span><span class="template-tag">&#123;% <span class="name"><span class="keyword">for</span></span> comment in comments %&#125;</span></span><br><span class="line"><span class="xml">		</span><span class="template-variable">&#123;&#123; render_comment(comment) &#125;&#125;</span></span><br><span class="line"><span class="xml">	</span><span class="template-tag">&#123;% <span class="name"><span class="keyword">endfor</span></span> %&#125;</span></span><br><span class="line"><span class="xml"><span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span></span><br></pre></td></tr></table></figure>

<p>宏可以单独放在一个文件中，以便重复使用</p>
<figure class="highlight django"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="template-tag">&#123;% <span class="name">import</span> &#x27;macros.html&#x27; <span class="keyword">as</span> macros %&#125;</span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">ul</span>&gt;</span></span></span><br><span class="line"><span class="xml">	</span><span class="template-tag">&#123;% <span class="name"><span class="name">for</span></span> comment <span class="keyword">in</span> comments %&#125;</span></span><br><span class="line"><span class="xml">		</span><span class="template-variable">&#123;&#123; macros.render_comment(comment) &#125;&#125;</span></span><br><span class="line"><span class="xml">	</span><span class="template-tag">&#123;% <span class="name"><span class="name">endfor</span></span> %&#125;</span></span><br><span class="line"><span class="xml"><span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span></span><br></pre></td></tr></table></figure>

<p>需要多次重复使用的模板代码片段也可以写到单独的文件中，再引入其他模板</p>
<figure class="highlight django"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="template-tag">&#123;% <span class="name"><span class="name">include</span></span> &#x27;common.html&#x27; %&#125;</span></span><br></pre></td></tr></table></figure>

<p>Jinja2支持模板继承，类似于类继承。首先，创建一个base.html的基模板</p>
<figure class="highlight twig"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span></span><br><span class="line"><span class="xml">	</span><span class="template-tag">&#123;% <span class="name"><span class="keyword">block</span></span> head %&#125;</span></span><br><span class="line"><span class="xml">	<span class="tag">&lt;<span class="name">title</span>&gt;</span></span><span class="template-tag">&#123;% <span class="name"><span class="keyword">block</span></span> title %&#125;</span><span class="template-tag">&#123;% <span class="name"><span class="keyword">endblock</span></span> %&#125;</span><span class="xml"> - My Application<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span></span><br><span class="line"><span class="xml">	</span><span class="template-tag">&#123;% <span class="name"><span class="keyword">endblock</span></span> %&#125;</span></span><br><span class="line"><span class="xml"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span></span><br><span class="line"><span class="xml">	</span><span class="template-tag">&#123;% <span class="name"><span class="keyword">block</span></span> body %&#125;</span></span><br><span class="line"><span class="xml">	</span><span class="template-tag">&#123;% <span class="name">end</span> <span class="name">block</span> %&#125;</span></span><br><span class="line"><span class="xml"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span></span><br></pre></td></tr></table></figure>

<p>基模板中定义的 block 可以在衍生模板中覆盖，本段定义了 head, title 和 body 区块，title包含在head中，衍生模板：</p>
<figure class="highlight django"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="template-tag">&#123;% <span class="name"><span class="name">extends</span></span> &#x27;base.html&#x27; %&#125;</span></span><br><span class="line"><span class="template-tag">&#123;% <span class="name"><span class="name">block</span></span> title %&#125;</span><span class="xml">Index</span><span class="template-tag">&#123;% <span class="name"><span class="name">endblock</span></span> %&#125;</span></span><br><span class="line"><span class="template-tag">&#123;% <span class="name"><span class="name">block</span></span> head %&#125;</span></span><br><span class="line"><span class="xml">	</span><span class="template-variable">&#123;&#123; super() &#125;&#125;</span></span><br><span class="line"><span class="xml">	<span class="tag">&lt;<span class="name">style</span>&gt;</span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span></span><br><span class="line"><span class="template-tag">&#123;% <span class="name"><span class="name">endblock</span></span> %&#125;</span></span><br><span class="line"><span class="template-tag">&#123;% <span class="name"><span class="name">block</span></span> body %&#125;</span></span><br><span class="line"><span class="template-tag">&#123;% <span class="name"><span class="name">endblock</span></span> %&#125;</span></span><br></pre></td></tr></table></figure>

<p>extends 表明要从 base.html继承，基模板中的block被重新定义，被子模板中同名区块的内容替代，子模板中可以使用 <code>super()</code>引用基模板的内容。</p>
<h3 id="使用Flask-Bootstrap集成Bootstrap"><a href="#使用Flask-Bootstrap集成Bootstrap" class="headerlink" title="使用Flask-Bootstrap集成Bootstrap"></a>使用Flask-Bootstrap集成Bootstrap</h3><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip <span class="keyword">install</span> flask-bootstrap</span><br></pre></td></tr></table></figure>

<figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">from flask_bootstrap import <span class="keyword">Bootstrap</span></span><br><span class="line"># ..</span><br><span class="line"><span class="keyword">bootstrap</span> = <span class="keyword">Bootstrap</span>(<span class="keyword">app</span>)</span><br></pre></td></tr></table></figure>

<p>初始化Bootstrap后，就可以使用包含Bootstrap文件的基模板，利用模板继承就可以使用。例如改写user.html：</p>
<figure class="highlight django"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="template-tag">&#123;% <span class="name"><span class="name">extends</span></span> &quot;bootstrap/base.html&quot; %&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="template-tag">&#123;% <span class="name"><span class="name">block</span></span> title %&#125;</span><span class="xml">Flasky</span><span class="template-tag">&#123;% <span class="name"><span class="name">endblock</span></span> %&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="template-tag">&#123;% <span class="name"><span class="name">block</span></span> navbar %&#125;</span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;navbar navbar-inverse&quot;</span> <span class="attr">role</span>=<span class="string">&quot;navigation&quot;</span>&gt;</span></span></span><br><span class="line"><span class="xml">	<span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;container&quot;</span>&gt;</span></span></span><br><span class="line"><span class="xml">		<span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;navbar-header&quot;</span>&gt;</span></span></span><br><span class="line"><span class="xml">			<span class="tag">&lt;<span class="name">button</span> <span class="attr">type</span>=<span class="string">&quot;button&quot;</span> <span class="attr">class</span>=<span class="string">&quot;navbar-toggle&quot;</span> <span class="attr">data-toggle</span>=<span class="string">&quot;collapse&quot;</span> <span class="attr">data-target</span>=<span class="string">&quot;.navbar-collapse&quot;</span>&gt;</span></span></span><br><span class="line"><span class="xml">				<span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">&quot;sr-only&quot;</span>&gt;</span>Toggle navigation<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span></span><br><span class="line"><span class="xml">				<span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">&quot;icon-bar&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">span</span>&gt;</span></span></span><br><span class="line"><span class="xml">				<span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">&quot;icon-bar&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">span</span>&gt;</span></span></span><br><span class="line"><span class="xml">				<span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">&quot;icon-bar&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">span</span>&gt;</span></span></span><br><span class="line"><span class="xml">			<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="xml">			<span class="tag">&lt;<span class="name">a</span> <span class="attr">class</span>=<span class="string">&quot;navbar-brand&quot;</span> <span class="attr">href</span>=<span class="string">&quot;/&quot;</span>&gt;</span>Flasky<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span></span><br><span class="line"><span class="xml">		<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="xml">		<span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;navbar-collapse collapse&quot;</span>&gt;</span></span></span><br><span class="line"><span class="xml">			<span class="tag">&lt;<span class="name">ul</span> <span class="attr">class</span>=<span class="string">&quot;nav navbar-nav&quot;</span>&gt;</span></span></span><br><span class="line"><span class="xml">				<span class="tag">&lt;<span class="name">li</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;/&quot;</span>&gt;</span>Home<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span></span><br><span class="line"><span class="xml">			<span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span></span><br><span class="line"><span class="xml">		<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="xml">	<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="template-tag">&#123;% <span class="name"><span class="name">endblock</span></span> %&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="template-tag">&#123;% <span class="name"><span class="name">block</span></span> content %&#125;</span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;container&quot;</span>&gt;</span></span></span><br><span class="line"><span class="xml">	<span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;page-header&quot;</span>&gt;</span></span></span><br><span class="line"><span class="xml">		<span class="tag">&lt;<span class="name">h1</span>&gt;</span>Hello, </span><span class="template-variable">&#123;&#123; name &#125;&#125;</span><span class="xml">!<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span></span><br><span class="line"><span class="xml">	<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="template-tag">&#123;% <span class="name"><span class="name">endblock</span></span> %&#125;</span></span><br></pre></td></tr></table></figure>

<p>bootstrap/base.html中定义了很多区块</p>
<table>
<thead>
<tr>
<th>区块</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>doc</td>
<td>整个HTML文档</td>
</tr>
<tr>
<td>html_attribs</td>
<td><code>&lt;html&gt;</code>标签的属性</td>
</tr>
<tr>
<td>html</td>
<td><code>&lt;html&gt;</code>标签中的内容</td>
</tr>
<tr>
<td>head</td>
<td><code>&lt;head&gt;</code>标签的内容</td>
</tr>
<tr>
<td>title</td>
<td><code>&lt;title&gt;</code>标签的内容</td>
</tr>
<tr>
<td>meta</td>
<td>一组<code>&lt;meta&gt;</code>标签</td>
</tr>
<tr>
<td>styles</td>
<td>CSS声明</td>
</tr>
<tr>
<td>body_attribs</td>
<td><code>&lt;body&gt;</code>标签的属性</td>
</tr>
<tr>
<td>body</td>
<td><code>&lt;body&gt;</code>标签的内容</td>
</tr>
<tr>
<td>navbar</td>
<td>用户定义的导航栏</td>
</tr>
<tr>
<td>content</td>
<td>用户定义的页面内容</td>
</tr>
<tr>
<td>scripts</td>
<td>文档底部的JavaScript声明</td>
</tr>
</tbody></table>
<p>很多区块里都有Bootstrap的自用内容，如果直接覆盖会产生问题，需要使用 super函数</p>
<figure class="highlight django"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="template-tag">&#123;% <span class="name"><span class="name">block</span></span> scripts %&#125;</span></span><br><span class="line"><span class="template-variable">&#123;&#123; super() &#125;&#125;</span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&#x27;my.js&#x27;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span></span><br><span class="line"><span class="template-tag">&#123;% <span class="name"><span class="name">endblock</span></span> %&#125;</span></span><br></pre></td></tr></table></figure>

<h3 id="自定义错误界面"><a href="#自定义错误界面" class="headerlink" title="自定义错误界面"></a>自定义错误界面</h3><p>Flask有errorhandler装饰器用于处理错误，错误页面可以由继承模板得到</p>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">@app</span>.errorhandler(<span class="number">404</span>)</span><br><span class="line">def page_not_found(e):</span><br><span class="line">	return render_template(<span class="string">&#x27;404.html&#x27;</span>),<span class="number">404</span></span><br><span class="line"></span><br><span class="line"><span class="variable">@app</span>.errorhandler(<span class="number">500</span>)</span><br><span class="line">def internal_server_error(e):</span><br><span class="line">	return render_template(<span class="string">&#x27;500.html&#x27;</span>),<span class="number">500</span></span><br></pre></td></tr></table></figure>

<p>模板可以多重继承，将上面的user.html的content和title区块的内容删除，命名为base.html，404.html只需继承base.html并覆盖这两个区块的内容即可生成自定义的错误页面。</p>
<h3 id="链接"><a href="#链接" class="headerlink" title="链接"></a>链接</h3><p>使用<code>url_for()</code>函数获得页面的链接，参数为视图函数名，动态URL需要传入关键字参数。例如：<code>url_for(user, name=&#39;john&#39;, page=2, version=1)</code>。</p>
<h3 id="静态文件"><a href="#静态文件" class="headerlink" title="静态文件"></a>静态文件</h3><p>服务器默认从static文件夹下寻找所需要的静态文件，使用<code>url_for(&#39;static&#39;, filename=&#39;css/style.css&#39;)</code>获得链接。</p>
<figure class="highlight handlebars"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="xml">&#123;% block head %&#125;</span></span><br><span class="line"><span class="template-variable">&#123;&#123; <span class="name">super</span>() &#125;&#125;</span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">&quot;shortcunt icon&quot;</span> <span class="attr">href</span>=<span class="string">&quot;</span></span></span><span class="template-variable">&#123;&#123; <span class="name">url</span>+for(<span class="name">&#x27;static&#x27;</span>, <span class="attr">filename</span>=<span class="string">&#x27;favicon.ico&#x27;</span>) &#125;&#125;</span><span class="xml"><span class="tag"><span class="string">&quot;</span> <span class="attr">type</span>=<span class="string">&quot;image/x-icon&quot;</span>&gt;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">&quot;icon&quot;</span> <span class="attr">href</span>=<span class="string">&quot;</span></span></span><span class="template-variable">&#123;&#123; <span class="name">url_for</span>(<span class="name">&#x27;static&#x27;</span>, <span class="attr">filename</span>=<span class="string">&#x27;favicon.ico&#x27;</span>) &#125;&#125;</span><span class="xml"><span class="tag"><span class="string">&quot;</span> <span class="attr">type</span>=<span class="string">&quot;image/x-icon&quot;</span>&gt;</span></span></span><br><span class="line"><span class="xml">&#123;% endblock %&#125;</span></span><br></pre></td></tr></table></figure>

<h3 id="使用Flask-Moment本地化日期和时间"><a href="#使用Flask-Moment本地化日期和时间" class="headerlink" title="使用Flask-Moment本地化日期和时间"></a>使用Flask-Moment本地化日期和时间</h3><p>服务器需要统一时间单位，一般使用UTC。不过用户需要的是当地的时间。Flask-moment是一个flask扩展，能简化把Moment.js集成到Jinja2模板的过程。<code>pip install flask-moment</code>。初始化Moment：</p>
<figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask_moment <span class="keyword">import</span> Moment</span><br><span class="line">moment = Moment(app)</span><br></pre></td></tr></table></figure>

<p>Flask-Moment依赖jQuery.js和Moment.js，引入Moment.js：</p>
<figure class="highlight clojure"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;% block scripts %&#125;</span><br><span class="line">&#123;&#123; super() &#125;&#125;</span><br><span class="line">&#123;&#123; moment.include_moment() &#125;&#125;</span><br><span class="line">&#123;% endblock %&#125;</span><br></pre></td></tr></table></figure>

<p>添加一个datetime变量：</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">from datetime <span class="keyword">import</span> datetime</span><br><span class="line"></span><br><span class="line"><span class="variable">@app</span>.route(<span class="string">&#x27;/&#x27;</span>)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">index</span></span>()<span class="symbol">:</span></span><br><span class="line">	<span class="keyword">return</span> render_tempalate(<span class="string">&#x27;index.html&#x27;</span>,currenttime=datetima.utcnow())</span><br></pre></td></tr></table></figure>

<p>渲染currenttime，<code>templates/index.html</code>：</p>
<figure class="highlight handlebars"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">p</span>&gt;</span>The local date and time is </span><span class="template-variable">&#123;&#123; <span class="name">cureent_time.format</span>(<span class="name">&#x27;LLL&#x27;</span>) &#125;&#125;</span><span class="xml">.<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">p</span>&gt;</span>That was </span><span class="template-variable">&#123;&#123; <span class="name">moment</span>(<span class="name">current_time.fromNow</span>(<span class="name">refresh</span>=<span class="literal">True</span>)) &#125;&#125;</span><span class="xml"><span class="tag">&lt;/<span class="name">p</span>&gt;</span></span></span><br></pre></td></tr></table></figure>

<p>这里的<code>format(&#39;LLL&#39;)</code>表示渲染的复杂度，从L到LLLL，还可以接受其他的格式说明符。<code>fromNow</code>渲染相对时间戳，会不断刷新。这个例子显示的是<code>July 18, 2019 12:12 AM</code>，<code>a few seconds ago</code>，随着时间变化还会变成<code>a minute ago</code>、<code>two mimutes ago</code>等等。可以使用<code>locale</code>本地化，例如</p>
<figure class="highlight handlebars"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="template-variable">&#123;&#123; <span class="name">moments.locale</span>(<span class="name">&#x27;es&#x27;</span>) &#125;&#125;</span></span><br></pre></td></tr></table></figure>

<h2 id="表单"><a href="#表单" class="headerlink" title="表单"></a>表单</h2><p>Flask本身可以处理表单，但可以使用flask-wtf进行简化。<code>pip install flask-wtf</code>。</p>
<h3 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h3><p>flask-wtf无需再应用层初始化，但需要配置密钥用于防止会话被篡改。</p>
<figure class="highlight isbl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">app</span> = <span class="function"><span class="title">Flask</span>(<span class="variable">__name__</span>)</span></span><br><span class="line"><span class="variable">app.config</span>[<span class="string">&#x27;SECRET_KEY&#x27;</span>] = <span class="string">&#x27;hard to guess&#x27;</span></span><br></pre></td></tr></table></figure>

<p>为了增强安全性，密钥通常不写在源代码中，而是保存在环境变量中。</p>
<h3 id="表单类"><a href="#表单类" class="headerlink" title="表单类"></a>表单类</h3><p>使用Flask-wtf时，每个web表单都由一个继承自FlaskForm的类表示。这个类定义表单中的一组字段，每个字段都用对象来表示。字段对象可以附属一个或多个验证函数用于验证用户提交的数据是否有效。</p>
<p>一个例子，包含一个文本字段和提交按钮：</p>
<figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask_wtf <span class="keyword">import</span> FlaskForm</span><br><span class="line"><span class="keyword">from</span> wtfroms <span class="keyword">import</span> StringField, SubmitField</span><br><span class="line"><span class="keyword">from</span> wtforms,validators <span class="keyword">import</span> DataRequired</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="symbol">NameForm</span>(<span class="symbol">FlaskForm</span>):</span><br><span class="line">	<span class="symbol">name</span> = <span class="symbol">StringField</span>(&#x27;<span class="symbol">What</span> <span class="symbol">is</span> <span class="symbol">your</span> <span class="symbol">name</span>?&#x27;, <span class="symbol">validators</span>=[<span class="symbol">DataRequired</span>()])</span><br><span class="line">	<span class="symbol">submit</span> = <span class="symbol">SubmitField</span>(&#x27;<span class="symbol">Submit</span>&#x27;)</span><br></pre></td></tr></table></figure>

<p>这个表单中的字段定义为类变量，各个类变量的值时相对应字段类型的对象。这个例子中NameForm表单中有一个名为name的文本字段和一个名为submit的提交按钮。StringField类表示属性为type=”text”的HTML input元素。SubmitField类表示属性为type=”submit”的元素。字段构造函数的第一个参数是渲染HTML时使用的标注label。Validators指定一个由验证函数组成的列表，在用户提交数据之前进行验证。</p>
<h3 id="渲染表单"><a href="#渲染表单" class="headerlink" title="渲染表单"></a>渲染表单</h3><p>在视图函数中通过form参数把一个NameForm实例传入模板，就可以生成一个HTML表单，可以传入关键字参数添加指定的属性，hidden_tag为表单添加CSRF token。</p>
<figure class="highlight handlebars"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">form</span> <span class="attr">method</span>=<span class="string">&quot;POST&quot;</span>&gt;</span></span></span><br><span class="line"><span class="xml">	</span><span class="template-variable">&#123;&#123; <span class="name">form.hidden_tag</span>() &#125;&#125;</span></span><br><span class="line"><span class="xml">	</span><span class="template-variable">&#123;&#123; <span class="name">form.name.label</span> &#125;&#125;</span><span class="template-variable">&#123;&#123; <span class="name">form.name</span>(<span class="name">id</span>=<span class="string">&#x27;namefiedl&#x27;</span>) &#125;&#125;</span></span><br><span class="line"><span class="xml">	</span><span class="template-variable">&#123;&#123; <span class="name">form.submit</span>() &#125;&#125;</span></span><br><span class="line"><span class="xml"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span></span><br></pre></td></tr></table></figure>

<p>使用这样的方式渲染和美化表单工作量依然很大，所以应该尽量使用bootstrap的表单样式，上述表单可以用以下方式渲染，其中<code>quick_form</code>的参数为FlaskWTF表单对象：</p>
<figure class="highlight clojure"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#123;% import <span class="string">&quot;bootstrap/wtf.html&quot;</span> %&#125;</span><br><span class="line">&#123;&#123; wtf.quick_form(<span class="name">form</span>) &#125;&#125;</span><br></pre></td></tr></table></figure>

<p>一个完整示例（templates/index.html）：</p>
<figure class="highlight django"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="template-tag">&#123;% <span class="name"><span class="name">extends</span></span> &quot;base.html&quot; %&#125;</span></span><br><span class="line"><span class="template-tag">&#123;% <span class="name">import</span> &quot;bootstrap/wtf.html&quot; <span class="keyword">as</span> wtf %&#125;</span></span><br><span class="line"><span class="template-tag">&#123;% <span class="name"><span class="name">block</span></span> title %&#125;</span><span class="xml">Flasky</span><span class="template-tag">&#123;% <span class="name"><span class="name">endblock</span></span> %&#125;</span></span><br><span class="line"><span class="template-tag">&#123;% <span class="name"><span class="name">block</span></span> page_content %&#125;</span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;page-header&quot;</span>&gt;</span></span></span><br><span class="line"><span class="xml">	<span class="tag">&lt;<span class="name">h1</span>&gt;</span>Hello, </span><span class="template-tag">&#123;% <span class="name"><span class="name">if</span></span> name %&#125;</span><span class="template-variable">&#123;&#123; name &#125;&#125;</span><span class="template-tag">&#123;% <span class="name"><span class="name">else</span></span> %&#125;</span><span class="xml">Stranger</span><span class="template-tag">&#123;% <span class="name"><span class="name">endif</span></span> %&#125;</span><span class="xml"><span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span></span><br><span class="line"><span class="template-variable">&#123;&#123; wtf.quick_form(form) &#125;&#125;</span></span><br><span class="line"><span class="template-tag">&#123;% <span class="name"><span class="name">endblock</span></span> %&#125;</span></span><br></pre></td></tr></table></figure>

<h3 id="在视图函数中处理表单"><a href="#在视图函数中处理表单" class="headerlink" title="在视图函数中处理表单"></a>在视图函数中处理表单</h3><p>视图函数需要渲染表单并且收集表单中的用户提交的数据。</p>
<figure class="highlight fortran"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">@app<span class="number">.</span>route(<span class="string">&#x27;/&#x27;</span>, methods=[<span class="string">&#x27;GET&#x27;</span>, <span class="string">&#x27;POST&#x27;</span>])</span><br><span class="line">def <span class="built_in">index</span>():</span><br><span class="line">	<span class="keyword">name</span> = <span class="keyword">None</span></span><br><span class="line">	<span class="keyword">form</span> = NameForm()</span><br><span class="line">	<span class="keyword">if</span> <span class="keyword">form</span><span class="number">.</span>validate_on_submit():</span><br><span class="line">		<span class="keyword">name</span> = <span class="keyword">form</span><span class="number">.</span><span class="keyword">name</span><span class="number">.</span><span class="keyword">data</span></span><br><span class="line">		<span class="keyword">form</span><span class="number">.</span><span class="keyword">name</span><span class="number">.</span><span class="keyword">data</span> = <span class="string">&#x27;&#x27;</span></span><br><span class="line">	<span class="keyword">return</span> render_template(<span class="string">&#x27;index.html&#x27;</span>, <span class="keyword">form</span>=<span class="keyword">form</span>, <span class="keyword">name</span>=<span class="keyword">name</span>)</span><br></pre></td></tr></table></figure>

<h3 id="重定向和用户会话"><a href="#重定向和用户会话" class="headerlink" title="重定向和用户会话"></a>重定向和用户会话</h3><p>上个函数存在一个问题，输入名字并且提交表单后，刷新会收到浏览器的警告，是否重新提交数据。因为最后一个请求是POST，刷新后浏览器会重新发送请求。使用重定向作为POST请求的响应，浏览器会重新发送一个GET请求。</p>
<p>这个方法也有一个问题，用户已经提交了名字，然而一旦用户刷新，POST请求结束，用户提交的数据就不见了。因此应用需要保存输入的名字，这样重定向后的请求才能获得并使用这个名字。</p>
<p>应用把数据存储在用户会话中，用户会话是一种私有存储，每个连接到服务器的客户端都可以访问，属于请求上下文中的变量，名为session，像标准的Python字典一样操作。默认情况下，用户会话保存在客户端的cookie中，使用之前设置的密钥加密签名。</p>
<p>实现重定向和用户会话：</p>
<figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, render_template, <span class="keyword">session</span>, redirect, url_for</span><br><span class="line"></span><br><span class="line">@app.route(<span class="string">&#x27;/&#x27;</span>, methods=[<span class="string">&#x27;GET&#x27;</span>, <span class="string">&#x27;POST&#x27;</span>])</span><br><span class="line">def <span class="keyword">index</span>():</span><br><span class="line">	form = NameForm()</span><br><span class="line">	<span class="keyword">if</span> form.validate_on_submit():</span><br><span class="line">		<span class="keyword">session</span>[<span class="string">&#x27;name&#x27;</span>] = form.name.data</span><br><span class="line">		<span class="keyword">return</span> redirect(url_for(<span class="string">&#x27;index&#x27;</span>))</span><br><span class="line">	<span class="keyword">return</span> render_template(<span class="string">&#x27;index.html&#x27;</span>, form=form, <span class="type">name</span>=<span class="keyword">session</span>.<span class="keyword">get</span>(<span class="string">&#x27;name&#x27;</span>))</span><br></pre></td></tr></table></figure>

<h3 id="闪现消息"><a href="#闪现消息" class="headerlink" title="闪现消息"></a>闪现消息</h3><p>请求完成后，有时需要让用户知道状态发生了改变，比如用户提交了错误的用户名或密码，服务器应该重新渲染表单，并且提示用户名或密码武侠，<code>flash()</code>函数提供这样的功能。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">from flask <span class="keyword">import</span> Flask, render_template, session, redirect, rul_for, flash</span><br><span class="line"><span class="meta">@app</span>.route(<span class="string">&#x27;/&#x27;</span>, methods=[<span class="string">&#x27;GET&#x27;</span>, <span class="string">&#x27;POST&#x27;</span>])</span><br><span class="line">def index():</span><br><span class="line">	form = NameForm()</span><br><span class="line">	<span class="keyword">if</span> form.validate_on_sumit():</span><br><span class="line">		old_name = session.<span class="keyword">get</span>(<span class="string">&#x27;name&#x27;</span>)</span><br><span class="line">		<span class="keyword">if</span> old_name <span class="keyword">is</span> not None and old_name != form.name.<span class="keyword">data</span>:</span><br><span class="line">			flash(<span class="string">&#x27;Looks like you have changed your name&#x27;</span>)</span><br><span class="line">		session[<span class="string">&#x27;name&#x27;</span>] = form.name.<span class="keyword">data</span></span><br><span class="line">		<span class="keyword">return</span> redirct(url_for(<span class="string">&#x27;index&#x27;</span>))</span><br><span class="line">	<span class="keyword">return</span> render_template(<span class="string">&#x27;index.html&#x27;</span>, form = form, name = session.<span class="keyword">get</span>(<span class="string">&#x27;name&#x27;</span>))</span><br></pre></td></tr></table></figure>

<p>只在视图函数中调用<code>flash()</code>并不能显示信息，模板必须对它进行渲染，可以在基膜版中渲染使得所有页面都能显示闪现信息。Flask为模板提供<code>get_flashed_messages()</code>用于获取和渲染信息。</p>
<figure class="highlight django"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="template-tag">&#123;% <span class="name"><span class="name">block</span></span> content %&#125;</span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;container&quot;</span>&gt;</span></span></span><br><span class="line"><span class="xml">	</span><span class="template-tag">&#123;% <span class="name"><span class="name">for</span></span> message <span class="keyword">in</span> get_flashed_messages() %&#125;</span></span><br><span class="line"><span class="xml">	<span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;alert alert-warning&quot;</span>&quot;&gt;</span></span></span><br><span class="line"><span class="xml">		<span class="tag">&lt;<span class="name">button</span> <span class="attr">type</span>=<span class="string">&quot;button&quot;</span> <span class="attr">class</span>=<span class="string">&quot;close&quot;</span> <span class="attr">data-dismiss</span>=<span class="string">&quot;alert&quot;</span>&gt;</span><span class="symbol">&amp;times;</span><span class="tag">&lt;/<span class="name">buttion</span>&gt;</span></span></span><br><span class="line"><span class="xml">		</span><span class="template-variable">&#123;&#123; message &#125;&#125;</span></span><br><span class="line"><span class="xml"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="template-tag">&#123;% <span class="name"><span class="name">endfor</span></span> %&#125;</span></span><br><span class="line"><span class="template-tag">&#123;% <span class="name"><span class="name">block</span></span> page_content %&#125;</span><span class="template-tag">&#123;% <span class="name"><span class="name">endblock</span></span> %&#125;</span></span><br></pre></td></tr></table></figure>

<h2 id="数据库"><a href="#数据库" class="headerlink" title="数据库"></a>数据库</h2><h3 id="SQL数据库"><a href="#SQL数据库" class="headerlink" title="SQL数据库"></a>SQL数据库</h3><p>关系型数据库把数据存储在表中，表为实体建模。表中的列数是固定的，行数是可变的。</p>
<h3 id="NoSQL数据库"><a href="#NoSQL数据库" class="headerlink" title="NoSQL数据库"></a>NoSQL数据库</h3><p>不符合以上关系模型的数据库统称为NoSQL数据库，一般使用集合代替表，使用文档代替记录。</p>
<h3 id="Python数据库框架"><a href="#Python数据库框架" class="headerlink" title="Python数据库框架"></a>Python数据库框架</h3><p>大多数数据库引擎提供对应的python包，如果无法满足需求，还有一些数据库抽象层代码包可选，例如 SQL Alchemy 和MongoEngine。</p>
<h3 id="使用-Flask-SQLAlchemy管理数据"><a href="#使用-Flask-SQLAlchemy管理数据" class="headerlink" title="使用 Flask-SQLAlchemy管理数据"></a>使用 Flask-SQLAlchemy管理数据</h3><p>Flask-SQLAlchemy是一个Flask扩展，简化了在Flask应用中使用SQLAlchemy的操作。<code>pip install flask-sqlalchemy</code>，数据库使用URL指定，几个例子：</p>
<table>
<thead>
<tr>
<th>数据库引擎</th>
<th>URL</th>
</tr>
</thead>
<tbody><tr>
<td>Mysql</td>
<td>mysql://username:password@hostname/database</td>
</tr>
<tr>
<td>Postgres</td>
<td>postgresql://username:password@hostname/database</td>
</tr>
<tr>
<td>SQLite(Linux, MacOS)</td>
<td>sqlite:////absolute/path/to/database</td>
</tr>
<tr>
<td>SQLite(Windows)</td>
<td>sqlite:///c:/absolute/path/to/database</td>
</tr>
</tbody></table>
<p>应用使用的数据库URL必须保存到Flask配置对象的SQLALCHEMY_DATABASE_URI键中。同时建议把SQLIALCHEMY_TRACK_MODIFICATIONS键设置为False，在不需要跟踪对象变化是降低内存消耗。初始化一个简单的SQLite数据库：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">import <span class="built_in">os</span></span><br><span class="line">from flask_sqlalchemy import SQLAlchemy</span><br><span class="line"></span><br><span class="line">basedir = <span class="built_in">os</span>.<span class="built_in">path</span>.absopath(<span class="built_in">os</span>.<span class="built_in">path</span>.dirname(__file__))</span><br><span class="line">app = Flask(__name__)</span><br><span class="line">app.<span class="built_in">config</span>[<span class="string">&#x27;SQLALCHEMY_DATABASE_URI&#x27;</span>] = <span class="string">&#x27;sqlite:///&#x27;</span> + <span class="built_in">os</span>.<span class="built_in">path</span>.join(basedir, <span class="string">&#x27;data.sqlite&#x27;</span>)</span><br><span class="line">app.<span class="built_in">config</span>[<span class="string">&#x27;SQLALCHEMY_TRACK_MODIFICATIONS&#x27;</span>] = False</span><br><span class="line">db = SQLAlchemy(app)</span><br></pre></td></tr></table></figure>

<p>db是SQLAlchemy类的实例，表示应用使用的数据库。</p>
<h3 id="定义模型"><a href="#定义模型" class="headerlink" title="定义模型"></a>定义模型</h3><p>模型表示应用使用的持久化实体。ORM中，模型一般是一个python类，其中的属性对应于数据库表中的列。定义Role和User模型：</p>
<figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="keyword">Role</span>(db.Model):</span><br><span class="line">	__tablename__ = <span class="string">&#x27;roles&#x27;</span></span><br><span class="line">	id = db.<span class="keyword">Column</span>(db.Integer, primary_key=<span class="keyword">True</span>)</span><br><span class="line">	<span class="type">name</span> = db.<span class="keyword">Column</span>(db.String(<span class="number">64</span>), <span class="keyword">unique</span>=<span class="keyword">True</span>)</span><br><span class="line">	def __repr__(self):</span><br><span class="line">		<span class="keyword">return</span> <span class="string">&#x27;&lt;Role %&gt;&#x27;</span> % self.name</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="keyword">User</span>(db.Model):</span><br><span class="line">	__tablename__ = <span class="string">&#x27;users&#x27;</span></span><br><span class="line">	id = db.<span class="keyword">Column</span>(db.Integer, primary_key=<span class="keyword">True</span>)</span><br><span class="line">	username = db.<span class="keyword">Column</span>(db.String(<span class="number">64</span>), <span class="keyword">unique</span>=<span class="keyword">True</span>, <span class="keyword">index</span>=<span class="keyword">True</span>)</span><br><span class="line">	def __repr__(self):</span><br><span class="line">		<span class="keyword">return</span> <span class="string">&#x27;&lt;User %&gt;&#x27;</span> % self.username</span><br></pre></td></tr></table></figure>

<p>Flask-SQLAlchemy要求每个模型都定义主键。</p>
<h3 id="关系"><a href="#关系" class="headerlink" title="关系"></a>关系</h3><p>定义关系：</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">class Role(db.Model):</span><br><span class="line">	# <span class="built_in">..</span>.</span><br><span class="line"><span class="built_in">	users </span>= db.relationship(<span class="string">&#x27;User&#x27;</span>, <span class="attribute">backref</span>=<span class="string">&#x27;role&#x27;</span>)</span><br><span class="line"></span><br><span class="line">class User(db.Model):</span><br><span class="line">	# <span class="built_in">..</span>.</span><br><span class="line">	role_id = db.Column(db.Integer, db.ForeignKey(<span class="string">&#x27;roles.id&#x27;</span>))</span><br></pre></td></tr></table></figure>

<h3 id="数据库操作"><a href="#数据库操作" class="headerlink" title="数据库操作"></a>数据库操作</h3><h4 id="创建-删除表"><a href="#创建-删除表" class="headerlink" title="创建/删除表"></a>创建/删除表</h4><figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">flask <span class="keyword">shell</span></span><br><span class="line">from hello import <span class="keyword">db</span></span><br><span class="line"><span class="keyword">db</span>.drop_all()</span><br><span class="line"><span class="keyword">db</span>.create_all()</span><br></pre></td></tr></table></figure>

<h4 id="插入行"><a href="#插入行" class="headerlink" title="插入行"></a>插入行</h4><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> hello import Role, User</span><br><span class="line">admin_role = Role(<span class="attribute">name</span>=<span class="string">&#x27;Admin&#x27;</span>)</span><br><span class="line">mod_role = Role(<span class="attribute">name</span>=<span class="string">&#x27;Moderator&#x27;</span>)</span><br><span class="line">user_role = Role(<span class="attribute">name</span>=<span class="string">&#x27;User&#x27;</span>)</span><br><span class="line">user_john = User(<span class="attribute">username</span>=<span class="string">&#x27;john&#x27;</span>, <span class="attribute">role</span>=admin_role)</span><br><span class="line">user_susan = User(<span class="attribute">username</span>=<span class="string">&#x27;susan&#x27;</span>, <span class="attribute">role</span>=user_role)</span><br><span class="line">user_david = User(<span class="attribute">username</span>=<span class="string">&#x27;david&#x27;</span>, <span class="attribute">role</span>=user_role)</span><br></pre></td></tr></table></figure>

<p>模型的构造函数接受的参数是使用关键字参数指定的模型属性初始值。role属性也可以使用，这是一对多关系的高级表示。新建对象是没有明确设定id属性，大多数数据库的主键由数据库自身管理。目前这些对象只存在于python中，没有写入数据库，所以id为None。</p>
<p>对数据库的改动通过数据库会话管理，在Flask-SQLAlchemy中，会话由db.session表示，准备把对象写入数据库之前，要首先将其添加到会话中。</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">db</span><span class="selector-class">.session</span><span class="selector-class">.add</span>(<span class="selector-tag">admin_role</span>)</span><br><span class="line"><span class="selector-tag">db</span><span class="selector-class">.session</span><span class="selector-class">.add</span>(<span class="selector-tag">mod_role</span>)</span><br><span class="line"><span class="selector-tag">db</span><span class="selector-class">.session</span><span class="selector-class">.add</span>(<span class="selector-tag">user_role</span>)</span><br><span class="line"><span class="selector-tag">eb</span><span class="selector-class">.session</span><span class="selector-class">.add</span>(<span class="selector-tag">user_john</span>)</span><br><span class="line"><span class="selector-tag">db</span><span class="selector-class">.session</span><span class="selector-class">.add</span>(<span class="selector-tag">user_susan</span>)</span><br><span class="line"><span class="selector-tag">db</span><span class="selector-class">.session</span><span class="selector-class">.add</span>(<span class="selector-tag">user_david</span>)</span><br></pre></td></tr></table></figure>

<p>或者可以简写为</p>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.session.add<span class="constructor">_all([<span class="params">admin_role</span>, <span class="params">mod_role</span>, <span class="params">user_role</span>, <span class="params">user_john</span>, <span class="params">user_susan</span>, <span class="params">user_david</span>])</span></span><br></pre></td></tr></table></figure>

<p>为了把对象写入数据库，需要调用commit方法提交会话：</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">db</span><span class="selector-class">.session</span><span class="selector-class">.commit</span>()</span><br></pre></td></tr></table></figure>

<p>数据库会话能保证数据的以执行，提交操作如果在写入会话的过程中发生了错误，整个会话都会失败，数据库会话也可以回滚，调用<code>db.session.rollback()</code>后，添加到数据库会话中的所有对象都将还原到它在数据库中的状态。</p>
<h4 id="修改行"><a href="#修改行" class="headerlink" title="修改行"></a>修改行</h4><p>在数据会话上调用add方法也能更新模型，把Admin角色重命名为Administrator：</p>
<figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">admin_role.name = <span class="string">&#x27;Administrator&#x27;</span></span><br><span class="line">db.<span class="keyword">session</span>.<span class="keyword">add</span>(admin_role)</span><br><span class="line">db.<span class="keyword">session</span>.<span class="keyword">commit</span></span><br></pre></td></tr></table></figure>

<h4 id="删除行"><a href="#删除行" class="headerlink" title="删除行"></a>删除行</h4><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">db</span><span class="selector-class">.session</span><span class="selector-class">.delete</span>(<span class="selector-tag">mod_role</span>)</span><br><span class="line"><span class="selector-tag">db</span><span class="selector-class">.session</span><span class="selector-class">.commit</span>()</span><br></pre></td></tr></table></figure>

<h4 id="查询行"><a href="#查询行" class="headerlink" title="查询行"></a>查询行</h4><p>Flask-Alchemy为每个模型类提供了query对象，最基本的模型查询使用all方法取回所有记录：</p>
<figure class="highlight fsharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Role.query.all()</span><br><span class="line"># <span class="meta">[&lt;Role &#x27;Administrator&#x27;&gt;, &lt;Role &#x27;User&#x27;&gt;]</span></span><br><span class="line">User.query.all()</span><br><span class="line"># <span class="meta">[&lt;User &#x27;john&#x27;&gt;, &lt;User &#x27;susan&#x27;&gt;, &lt;User &#x27;david&#x27;&gt;]</span></span><br></pre></td></tr></table></figure>

<p>使用过滤器可以配置query对象以进行更精准的查询，查找角色为User的用户：</p>
<figure class="highlight fsharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">User.query.filter_by(role=user_role).all()</span><br><span class="line"># <span class="meta">[&lt;User &#x27;susan&#x27;&gt;, &lt;User &#x27;david&#x27;&gt;]</span></span><br></pre></td></tr></table></figure>

<p>如果要查看SQLALlchemy为查询生成的SQL查询语句，只需要把query对象转换为字符串：</p>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">str(<span class="module-access"><span class="module"><span class="identifier">User</span>.</span></span>query.filter<span class="constructor">_be(<span class="params">role</span>=<span class="params">user_role</span>)</span>)</span><br><span class="line">&#x27;SELECT users.id AS users_id, users.username AS users_username, users.role_id AS users_role_id \nFROM Users \nWHERE :param_1 = users.role_id&#x27;</span><br></pre></td></tr></table></figure>

<p>r如果推出了shell会话，前面这些例子中创建的对象不会以python对象的形式存在，但在数据库中仍有相应的行。可以从数据库读取行，重新创建Python对象，如加载名为User的user_role：</p>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">user_role = <span class="module-access"><span class="module"><span class="identifier">Role</span>.</span></span>query.filter<span class="constructor">_by(<span class="params">name</span>=&#x27;User&#x27;)</span>.first<span class="literal">()</span></span><br></pre></td></tr></table></figure>

<p>first方法返回第一个结果，如果没有则返回None。</p>
<p>filter_by等过滤器在query对象上调用，返回一个过滤后的query对象。</p>
<p>关系与查询的处理方式类似，下面这个例子分别从关系的两端查询用户和角色的一对多关系</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">users = user_role.users</span><br><span class="line">users</span><br><span class="line"><span class="comment"># [&lt;User &#x27;susan&#x27;&gt;, &lt;User &#x27;david&#x27;&gt;</span></span><br><span class="line">users[0].role</span><br><span class="line"><span class="comment"># &lt;Role &#x27;User&#x27;&gt;</span></span><br></pre></td></tr></table></figure>

<p>有个小问题，执行<code>user_role.user</code>时会隐式调用all()方法，返回一个列表，此时query对象时隐藏的，无法指定过滤器。可以加入<code>lazy=&#39;dynamic&#39;</code>参数，禁止自动查询。</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">class Role(db.Model):</span><br><span class="line">	#<span class="built_in">..</span>.</span><br><span class="line"><span class="built_in">	users </span>= db.realationship(<span class="string">&#x27;User&#x27;</span>, <span class="attribute">backref</span>=<span class="string">&#x27;role&#x27;</span>, <span class="attribute">lazy</span>=<span class="string">&#x27;dynamic&#x27;</span>)</span><br><span class="line">	# <span class="built_in">..</span>.</span><br></pre></td></tr></table></figure>

<p>这样user.role.users会返回一个query对象，可以添加过滤器。</p>
<h3 id="在视图函数中操作数据库"><a href="#在视图函数中操作数据库" class="headerlink" title="在视图函数中操作数据库"></a>在视图函数中操作数据库</h3><p>前一节的数据库操作可以直接在视图函数中进行，把用户输入的名字记录到数据库中（hello.py）：</p>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">@app.route(<span class="character">&#x27;/&#x27;</span>, methods=<span class="literal">[&#x27;GET&#x27;, &#x27;POST&#x27;]</span>)</span><br><span class="line">def index<span class="literal">()</span>:</span><br><span class="line">	form = <span class="constructor">NameForm()</span></span><br><span class="line">	<span class="keyword">if</span> form.validate<span class="constructor">_on_submit()</span></span><br><span class="line">		user = <span class="module-access"><span class="module"><span class="identifier">User</span>.</span></span>query.filter<span class="constructor">_by(<span class="params">username</span>=<span class="params">form</span>.<span class="params">name</span>.<span class="params">data</span>)</span>.first<span class="literal">()</span></span><br><span class="line">		<span class="keyword">if</span> user is None:</span><br><span class="line">			user = <span class="constructor">User(<span class="params">username</span>=<span class="params">form</span>.<span class="params">name</span>.<span class="params">data</span>)</span></span><br><span class="line">			db.session.add(user)</span><br><span class="line">			db.session.commit<span class="literal">()</span></span><br><span class="line">			session<span class="literal">[&#x27;<span class="identifier">known</span>&#x27;]</span> = False</span><br><span class="line">		<span class="keyword">else</span>:</span><br><span class="line">			session<span class="literal">[&#x27;<span class="identifier">known</span>&#x27;]</span> = True</span><br><span class="line">		session<span class="literal">[&#x27;<span class="identifier">name</span>&#x27;]</span> = form.name.data</span><br><span class="line">		form.name.data = &#x27;&#x27;</span><br><span class="line">		return redirect(url<span class="constructor">_for(&#x27;<span class="params">index</span>&#x27;)</span>)</span><br><span class="line">	return render<span class="constructor">_template(&#x27;<span class="params">index</span>.<span class="params">html</span>&#x27;, <span class="params">form</span>=<span class="params">form</span>, <span class="params">name</span>=<span class="params">session</span>.<span class="params">get</span>(&#x27;<span class="params">name</span>&#x27;)</span>, known=session.get(&#x27;known&#x27;, False))</span><br></pre></td></tr></table></figure>

<p>为了正常运行，需要先在shell中创建数据库表。通过knowns可以对已知用户和新用户显示不同的内容（templates/index.html）：</p>
<figure class="highlight django"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="template-tag">&#123;% <span class="name"><span class="name">extends</span></span> &quot;base.html&quot; %&#125;</span></span><br><span class="line"><span class="template-tag">&#123;% <span class="name">import</span> &quot;bootstrap/wtf.html&quot; <span class="keyword">as</span> wtf %&#125;</span></span><br><span class="line"><span class="template-tag">&#123;% <span class="name"><span class="name">block</span></span> title %&#125;</span><span class="xml">Flasky</span><span class="template-tag">&#123;% <span class="name"><span class="name">endblock</span></span> %&#125;</span></span><br><span class="line"><span class="template-tag">&#123;% <span class="name"><span class="name">block</span></span> page_content %&#125;</span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;page-header&quot;</span>&gt;</span></span></span><br><span class="line"><span class="xml">	<span class="tag">&lt;<span class="name">h1</span>&gt;</span>Hello, </span><span class="template-tag">&#123;% <span class="name"><span class="name">if</span></span> name %&#125;</span><span class="template-variable">&#123;&#123; name &#125;&#125;</span><span class="template-tag">&#123;% <span class="name"><span class="name">else</span></span> %&#125;</span><span class="xml">Stranger</span><span class="template-tag">&#123;% <span class="name"><span class="name">endif</span></span> %&#125;</span><span class="xml"><span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span></span><br><span class="line"><span class="xml">	</span><span class="template-tag">&#123;% <span class="name"><span class="name">if</span></span> not known %&#125;</span></span><br><span class="line"><span class="xml">	<span class="tag">&lt;<span class="name">p</span>&gt;</span>Pleased to meet you!<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span></span><br><span class="line"><span class="xml">	</span><span class="template-tag">&#123;% <span class="name"><span class="name">else</span></span> %&#125;</span></span><br><span class="line"><span class="xml">	<span class="tag">&lt;<span class="name">p</span>&gt;</span>Happy to see you again!<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span></span><br><span class="line"><span class="xml">	</span><span class="template-tag">&#123;% <span class="name"><span class="name">endif</span></span> %&#125;</span></span><br><span class="line"><span class="xml"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="template-variable">&#123;&#123; wtf.quick_form(form) &#125;&#125;</span></span><br><span class="line"><span class="template-tag">&#123;% <span class="name"><span class="name">endblock</span></span> %&#125;</span></span><br></pre></td></tr></table></figure>

<h3 id="集成python-shell"><a href="#集成python-shell" class="headerlink" title="集成python shell"></a>集成python shell</h3><p>每次启动会话都要导入数据库实例和模型，可以通过配置让flask shell命令自动导入这些对象。若想把对象添加到导入列表，必须使用<code>app.shell_context_processor</code>装饰器创建并注册一个shell上下文管理器：</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">@app.shell_context_processor</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">make_shell_context</span><span class="params">()</span></span><span class="symbol">:</span></span><br><span class="line">	<span class="keyword">return</span> dict(db=db, User=User, Role=Role)</span><br></pre></td></tr></table></figure>

<p>这个shell上下文处理器函数返回一个字典，包含数据库实例和模型，除了默认导入的app以外，flask shell命令将自动吧这些对象导入shell。</p>
<h3 id="使用Flask-Migrate实现数据库迁移"><a href="#使用Flask-Migrate实现数据库迁移" class="headerlink" title="使用Flask-Migrate实现数据库迁移"></a>使用Flask-Migrate实现数据库迁移</h3><p>开发过程中，有时需要修改数据库模型，而且修改之后要更新数据库。当数据库表不存在时，Flask-SQLAlchemy才会根据模型创建。因此，更新表需要删除旧表，但是会丢失所有数据。</p>
<p>更好的方法是使用数据库迁移框架，它可以追踪数据库模式的变化，然后以增量方式把变化应用到数据库中。SQLAlchemy开发人员编写了一个迁移框架名为Alembic，Flask由Flask-Migrate扩展。</p>
<h4 id="创建迁移仓库"><a href="#创建迁移仓库" class="headerlink" title="创建迁移仓库"></a>创建迁移仓库</h4><p>先安装Flask-Migrate，<code>pip install flask-migrate</code></p>
<p>初始化：</p>
<figure class="highlight capnproto"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask_migrate <span class="keyword">import</span> Migrate</span><br><span class="line"></span><br><span class="line"><span class="comment"># ...</span></span><br><span class="line">migrate = Migrate(app.db)</span><br></pre></td></tr></table></figure>

<p>Flask-Migrate添加了 flask db命令和几个子命令，新项目中可以使用init子命令添加迁移支持</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">flask db <span class="keyword">init</span></span><br></pre></td></tr></table></figure>

<p>这会创建 migrations 目录，所有迁移脚本存放在这里。</p>
<h2 id="电子邮件"><a href="#电子邮件" class="headerlink" title="电子邮件"></a>电子邮件</h2><p>Flask-Mail插件提供电子邮件支持，需要时查阅。</p>
<h2 id="大型应用的结构"><a href="#大型应用的结构" class="headerlink" title="大型应用的结构"></a>大型应用的结构</h2><p>Flask 并不强制开发者使用特定方式组织大型应用，以下介绍一种用包和模块组织大型应用的方式。</p>
<h3 id="项目结构"><a href="#项目结构" class="headerlink" title="项目结构"></a>项目结构</h3><figure class="highlight 1c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">|-flasky/</span></span><br><span class="line">	<span class="string">|-app/</span></span><br><span class="line">		<span class="string">|-templates/</span></span><br><span class="line">		<span class="string">|-static/</span></span><br><span class="line">		<span class="string">|-main/</span></span><br><span class="line">			<span class="string">|-__init__.py</span></span><br><span class="line">			<span class="string">|-errors.py</span></span><br><span class="line">			<span class="string">|-forms.py</span></span><br><span class="line">			<span class="string">|-views.py</span></span><br><span class="line">		<span class="string">|-__init__.py</span></span><br><span class="line">		<span class="string">|-email.py</span></span><br><span class="line">		<span class="string">|-models.py</span></span><br><span class="line">	<span class="string">|-migrations/</span></span><br><span class="line">	<span class="string">|-tests/</span></span><br><span class="line">		<span class="string">|-__init__.py</span></span><br><span class="line">		<span class="string">|-test*.py</span></span><br><span class="line">	<span class="string">|-venv/</span></span><br><span class="line">	<span class="string">|-requirements.txt</span></span><br><span class="line">	<span class="string">|-config.py</span></span><br><span class="line">	<span class="string">|-flasky.py</span></span><br></pre></td></tr></table></figure>

<p>说明：</p>
<ul>
<li><p>app/ 保存Flask 应用</p>
</li>
<li><p>migrations/ 保存数据库迁移脚本</p>
</li>
<li><p>test/ 单元测试</p>
</li>
<li><p>venv/ Python虚拟环境</p>
</li>
<li><p>requirements.txt 列出所有依赖包，便于在其他计算机中重新生成i昂同的虚拟环境</p>
</li>
<li><p>config.py 存储配置</p>
</li>
<li><p>flasky.py 定义Flask应用实例，辅助管理应用</p>
</li>
</ul>
<h3 id="配置选项"><a href="#配置选项" class="headerlink" title="配置选项"></a>配置选项</h3><p>除去之前 hello.py 中类似字典的 <code>app.config</code>对象之外，可以使用具有层次结构的配置类。config.py：</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">import os</span><br><span class="line">basedir = os.path.abspath(os.path.dirname(__file__))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">class Config:</span><br><span class="line">	SECRET_KEY = os.environ.<span class="builtin-name">get</span>(<span class="string">&#x27;SECRET_KEY&#x27;</span>) <span class="keyword">or</span> <span class="string">&#x27;hard to guess string&#x27;</span></span><br><span class="line">	MAIL_SERVER = os.environ.<span class="builtin-name">get</span>(<span class="string">&#x27;MAIL_SERVER&#x27;</span>, <span class="string">&#x27;smtp.googlemail.com&#x27;</span>)</span><br><span class="line">	MAIL_PORT = int(os.environ.<span class="builtin-name">get</span>(<span class="string">&#x27;MAIL_PORT&#x27;</span>, <span class="string">&#x27;587&#x27;</span>))</span><br><span class="line">	MAIL_USE_TLE = os.environ.<span class="builtin-name">get</span>(<span class="string">&#x27;MAIL_USE_TLS&#x27;</span>, <span class="string">&#x27;tls&#x27;</span>).lower() <span class="keyword">in</span> [<span class="string">&#x27;true&#x27;</span>, <span class="string">&#x27;on&#x27;</span>, <span class="string">&#x27;1&#x27;</span>]</span><br><span class="line">	MAIL_USERNAME = os.environ.<span class="builtin-name">get</span>(<span class="string">&#x27;MAIL_USERNAME&#x27;</span>)</span><br><span class="line">	MAIL_PASSWORD = os.environ.<span class="builtin-name">get</span>(<span class="string">&#x27;MAIL_PASSWORD&#x27;</span>)</span><br><span class="line">	FLASKY_MAIL_SUBJECT_PREFIX = <span class="string">&#x27;[flasky]&#x27;</span></span><br><span class="line">	FLASKY_MAIL_SENDER = <span class="string">&#x27;Flasky Admin &lt;flasky@example.com&gt;&#x27;</span></span><br><span class="line">	FLASKY_ADMIN = os.environ.<span class="builtin-name">get</span>(<span class="string">&#x27;FLASKY_ADMIN&#x27;</span>)</span><br><span class="line">	SQLALCHEMY_TRACK_MODIFICATIONS = <span class="literal">False</span></span><br><span class="line">	</span><br><span class="line">	@staticmethod</span><br><span class="line">	def init_app(app):</span><br><span class="line">		pass</span><br><span class="line"></span><br><span class="line">class DevelpmentConfig(Config):</span><br><span class="line">	<span class="builtin-name">DEBUG</span> = <span class="literal">True</span></span><br><span class="line">	SQLALCHEMY_DATABASE_URI = os.environ.<span class="builtin-name">get</span>(<span class="string">&#x27;DEV_DATABASE_URL&#x27;</span>) <span class="keyword">or</span> <span class="string">&#x27;sqlite:///&#x27;</span> + os.path.join(basedir, <span class="string">&#x27;data-dev.sqlite&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">class TestingConfig(Config):</span><br><span class="line">	TESTING = <span class="literal">True</span></span><br><span class="line">	SQLALCHEMY_DATABASE_URI = os.environ.<span class="builtin-name">get</span>(<span class="string">&#x27;TEST_DAATABASE_URL&#x27;</span>) <span class="keyword">or</span> <span class="string">&#x27;sqlite://&#x27;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">class ProductionConfig(Config):</span><br><span class="line">	SQLALCHEMY_DATABASE_URI = os.environ.<span class="builtin-name">get</span>(<span class="string">&#x27;DATABASE_URI&#x27;</span>) <span class="keyword">or</span> <span class="string">&#x27;sqlite://&#x27;</span> + os.path.join(basedir, <span class="string">&#x27;data.sqlite&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">config = &#123;</span><br><span class="line">	<span class="string">&#x27;development&#x27;</span>: DevelopmentConfig,</span><br><span class="line">	<span class="string">&#x27;tessting&#x27;</span>: TestingConfig,</span><br><span class="line">	<span class="string">&#x27;production&#x27;</span>: ProductionConfig,</span><br><span class="line">	</span><br><span class="line">	<span class="string">&#x27;default&#x27;</span>: DeevelopmentConfig</span><br><span class="line">&#125;	</span><br></pre></td></tr></table></figure>

<p>基类Config 包含通用配置，各个子类分别定义专用的配置。为了灵活和安全，多数配置都可以从环境变量中导入。千万不能把敏感信息写在纳入版本控制系统的配置文件中。Config及其子类可以定义 init_app()方法，其参数为应用实例。</p>
<h3 id="应用包"><a href="#应用包" class="headerlink" title="应用包"></a>应用包</h3><p>应用包用于夫南方应用的所有代码，模板和静态文件，我们可以直接把这个包成为 app，也可以使用一个专属名称。templates 和 static 目录现在是应用包的一部分，数据库模型和电子邮件支持函数也要放到这个包中。</p>
<h4 id="使用应用工厂函数"><a href="#使用应用工厂函数" class="headerlink" title="使用应用工厂函数"></a>使用应用工厂函数</h4><p>在单个文件开发应用有个很大的缺点：应用在全局作用域中创建，无法动态修改配置。解决办法是延迟创建实例，把创建过程移到可显式调用的 工厂函数中。不仅可以给脚本留出配置应用的时间，还能够创建多个应用实例，方便测试。工厂函数在 app 包的构造文件中定义。<code>app/__init__.py</code>：</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask import Flask, render_template</span><br><span class="line"><span class="keyword">from</span> flask_botstrap import Bootstrap</span><br><span class="line"><span class="keyword">from</span> flask_mail import Mail</span><br><span class="line"><span class="keyword">from</span> flask_moment import  Moment</span><br><span class="line"><span class="keyword">from</span> flassk_sqlalchemy import SQLAlchemy</span><br><span class="line"><span class="keyword">from</span><span class="built_in"> config </span>import config</span><br><span class="line"></span><br><span class="line">bootstrap = Bootstrap()</span><br><span class="line">mail = Mail()</span><br><span class="line">moment = Moment()</span><br><span class="line">db = SQLAlchemy()</span><br><span class="line"></span><br><span class="line">def create_app(config_name):</span><br><span class="line">	app = Flask(__name__)</span><br><span class="line">	app.config.from_object(config[onfig_name])</span><br><span class="line">	config[config_name].init_app(app)</span><br><span class="line">	</span><br><span class="line">	bootstrap.init_app(app)</span><br><span class="line">	mail.init__app(app)</span><br><span class="line">	moment.init_app(app)</span><br><span class="line">	db.init_app(app)</span><br><span class="line">	</span><br><span class="line">	# 添加路由和自定义错误页面</span><br><span class="line">	</span><br><span class="line">	return app</span><br></pre></td></tr></table></figure>

<p>构造文件导入了大多数正在使用的Flask扩展，由于尚未初始化所需的应用实例，所以创建扩展类时没有向构造函数传入参数，因此扩展并未初始化。<code>create_app()</code>时应用的工厂函数，接受一个参数，应用使用的配置名。配置类在 config.py 中定义。其中定义的配置可以使用app.config提供的from_object 方法直接导入应用。应用创建并且配置完成后就可以初始化扩展，在之前创建的对象上调用<code>init_app()</code>完成初始化，可以实现更复杂的初始化。</p>
<p>这个工厂函数创建的应用还不完整，因为没有路由和自定义的错误页面处理程序。</p>
<h4 id="在蓝本中实现应用功能"><a href="#在蓝本中实现应用功能" class="headerlink" title="在蓝本中实现应用功能"></a>在蓝本中实现应用功能</h4><p>转换成工厂函数让定义路由变得复杂了。在单脚本应用中，应用实例存在于全局变量作用域，路由可以直接使用<code>app.route</code>装饰器定义。但现在应用在运行时创建，只有调用 create_app 之后才能使用 app.route 装饰器，这是定义路由就太晚了。自定义的错误页面同理。</p>
<p>Flask使用蓝本 blueprint 提供了解决办法。蓝本与应用类似，可以定义路由和错误处理程序，不同的是，蓝本中定义的路由和错误处理程序处于休眠状态，知道蓝本注册到应用上之后，他们才真正成为应用的一部分。使用位于全局作用域中的蓝本时，定义路由和错误处理程序的方法几乎与但脚本应用一样。</p>
<p>蓝本可以在单个文件中定义，也可以使用更结构化的方式在包中的多个模块中创建。为了获得灵活性，我们在应用包中创建一个子包，用于保存应用的第一个蓝本。<code>app/main/__init__.py</code>：</p>
<figure class="highlight clean"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Bluprint</span><br><span class="line"></span><br><span class="line">main = Blueprint(<span class="string">&#x27;main&#x27;</span>, __name__)</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> . <span class="keyword">import</span> views, errors</span><br></pre></td></tr></table></figure>

<p>蓝本通过实例化一个Blueprint类对象，这个构造函数有两个必须指定的参数，蓝本名称和蓝本所在的包或模块。与应用一样，第二个参数一般使用<code>__name__</code>。</p>
<p>应用的路由保存在在 app/main/views.py 中，错误处理保存在 app/main/errors.py 中，导入这两个模块就能把路由和错误处理程序与蓝本关联起来。导入在末尾进行时为了防止循环导入依赖，因为在 view 和 errors 中还要导入 main 蓝本。</p>
<p>蓝本在工厂函数<code>create_app()</code>中注册到应用上，<code>app/__init__.py</code>：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">create_app</span>(<span class="params">config_name</span>):</span></span><br><span class="line">	<span class="keyword">from</span> .main <span class="keyword">import</span> main <span class="keyword">as</span> main_blueprint</span><br><span class="line">	app.register_blueprint(main_blueprint)</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">return</span> app</span><br></pre></td></tr></table></figure>

<p>错误处理程序，<code>app/main/errors.py</code>：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> render_template</span><br><span class="line"><span class="keyword">from</span> . <span class="keyword">import</span> main</span><br><span class="line"></span><br><span class="line"><span class="meta">@main.app_errorhandler(404):</span></span><br><span class="line">	<span class="function"><span class="keyword">def</span> <span class="title">page_not_found</span>(<span class="params">e</span>):</span></span><br><span class="line">		<span class="keyword">return</span> render_template(<span class="string">&#x27;404.html&#x27;</span>),<span class="number">400</span></span><br><span class="line">	</span><br><span class="line"><span class="meta">@main.app_errorhandler(500):</span></span><br><span class="line">	<span class="function"><span class="keyword">def</span> <span class="title">internal_server_error</span>(<span class="params">e</span>):</span></span><br><span class="line">		<span class="keyword">return</span> render_template(<span class="string">&#x27;500.html&#x27;</span>),<span class="number">500</span></span><br></pre></td></tr></table></figure>

<p>在蓝本中编写错误处理程序稍有不同，如果使用errorhandler装饰器，则只有蓝本中的错误才能触发，要想注册应用全局的错误处理程序，必须使用 app_errorhandler装饰器。</p>
<p>在蓝本中定义路由，<code>app/main/views.py</code>：</p>
<figure class="highlight coffeescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> datetime <span class="keyword">import</span> datetime</span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> render_template, session, redirect, url_for</span><br><span class="line"><span class="keyword">from</span> . impot main</span><br><span class="line"><span class="keyword">from</span> .forms <span class="keyword">import</span> NameFrom</span><br><span class="line"><span class="keyword">from</span> .. <span class="keyword">import</span> db</span><br><span class="line"><span class="keyword">from</span> ..models <span class="keyword">import</span> User</span><br><span class="line"></span><br><span class="line">@main.route(<span class="string">&#x27;/&#x27;</span>, methods=[<span class="string">&#x27;GET&#x27;</span>, <span class="string">&#x27;POST&#x27;</span>])</span><br><span class="line">def index():</span><br><span class="line">	form = NameForm()</span><br><span class="line">	<span class="keyword">if</span> form.validate_on_submit():</span><br><span class="line">		<span class="comment"># ...</span></span><br><span class="line">		<span class="keyword">return</span> redirect(url_for(<span class="string">&#x27;main.index&#x27;</span>))</span><br><span class="line">	<span class="keyword">return</span> render_template(<span class="string">&#x27;index.html&#x27;</span>, form=form, message=session.get(<span class="string">&#x27;name&#x27;</span>), known=session.get(<span class="string">&#x27;known&#x27;</span>, False), current_time=datetime.utcnow())</span><br></pre></td></tr></table></figure>

<p>在脚本中编写视图函数主要有两点不同：第一，与前面的错误处理程序一样，路由装饰器由蓝本提供，因此使用的是main.route，而非app.route；第二，url_for 函数的用法不同，在蓝本中，Flask会为所有蓝本中的端点加上一个命名空间，这样就可以在不同的蓝本中使用相同的端点名定义视图函数而不产生冲突。命名空间是蓝本的名称，即 Blueprint 构造函数的第一个参数，而且它与端点名之间以一个 . 分割。因此视图函数 index 注册的端点名为 main.index, url使用 <code>url_for(&#39;main.index&#39;)</code>获取。蓝本中，url_for可以使用省略形式，省略蓝本名，<code>url_for(&#39;.index&#39;)</code>。</p>
<p>需要引入表单对象，保存在<code>app/main/forms.py</code>。</p>
<h3 id="应用脚本"><a href="#应用脚本" class="headerlink" title="应用脚本"></a>应用脚本</h3><p>应用实例在顶级目录的 flasky.py 中定义。<code>flasky.py</code>：</p>
<figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">from</span> app <span class="keyword">import</span> create_app, db</span><br><span class="line"><span class="keyword">from</span> app.modules <span class="keyword">import</span> <span class="keyword">User</span>, <span class="keyword">Role</span></span><br><span class="line"><span class="keyword">from</span> flask_migrate <span class="keyword">import</span> Migrate</span><br><span class="line"></span><br><span class="line">app = create_app(os.getenv(<span class="string">&#x27;FLASK_CONFIG&#x27;</span>) <span class="keyword">or</span> <span class="string">&#x27;defalt&#x27;</span>)</span><br><span class="line">migrate = Migrate(app, db)</span><br><span class="line"></span><br><span class="line">@app.shell_context_processor</span><br><span class="line">def make_shell_context():</span><br><span class="line">	<span class="keyword">return</span> dict(db=db, <span class="keyword">User</span>=<span class="keyword">User</span>, <span class="keyword">Role</span>=<span class="keyword">Role</span>)</span><br></pre></td></tr></table></figure>

<p>这个脚本创建应用实例，读取环境变量，初始化 Flask-Migrate 为Python shell 定义上下文。</p>
<p>设置环境变量：</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="builtin-name">export</span> <span class="attribute">FLASK_APP</span>=flasky.py</span><br><span class="line"><span class="builtin-name">export</span> <span class="attribute">FLASK_DEBUG</span>=1</span><br></pre></td></tr></table></figure>

<h3 id="需求文件"><a href="#需求文件" class="headerlink" title="需求文件"></a>需求文件</h3><p>requirements.txt文件用于记录所有依赖包及其版本号，可以在另一台计算机上重新恒诚虚拟环境。</p>
<p>生成：<code>pip freeze &gt; requirements.txt</code></p>
<p>还原：<code>pip install -r requiirements.txt</code></p>
<h3 id="单元测试"><a href="#单元测试" class="headerlink" title="单元测试"></a>单元测试</h3><p>简单的两个测试，<code>tests/test_basics.py</code>：</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">import unittest</span><br><span class="line">from flask import current_app</span><br><span class="line">from app import create_app, db</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BasicsTestCase</span>(<span class="title">unittest</span>.<span class="title">Testcase</span>):</span></span><br><span class="line">	<span class="function"><span class="keyword">def</span> <span class="title">setUb</span><span class="params">(<span class="keyword">self</span>)</span></span><span class="symbol">:</span></span><br><span class="line">		<span class="keyword">self</span>.app = create_app(<span class="string">&#x27;testing&#x27;</span>)</span><br><span class="line">		<span class="keyword">self</span>.app_context = <span class="keyword">self</span>.app.app_context</span><br><span class="line">		<span class="keyword">self</span>.app_context.push()</span><br><span class="line">		db.create_all()</span><br><span class="line">		</span><br><span class="line">	<span class="function"><span class="keyword">def</span> <span class="title">tearDown</span><span class="params">(<span class="keyword">self</span>)</span></span><span class="symbol">:</span></span><br><span class="line">		db.session.remove()</span><br><span class="line">		db.drop_all()</span><br><span class="line">		<span class="keyword">self</span>.app_context.pop()</span><br><span class="line">		</span><br><span class="line">	<span class="function"><span class="keyword">def</span> <span class="title">test_app_exitsts</span><span class="params">(<span class="keyword">self</span>)</span></span><span class="symbol">:</span></span><br><span class="line">		<span class="keyword">self</span>.assertFalse(current_app is None)</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">def</span> <span class="title">test_app_is_testing</span><span class="params">(<span class="keyword">self</span>)</span></span><span class="symbol">:</span></span><br><span class="line">		<span class="keyword">self</span>.assertTure(current_app.config[<span class="string">&#x27;TESTING&#x27;</span>])</span><br></pre></td></tr></table></figure>

<p>使用 unittest 包编写，测试用例类的 setUp 和 tearDown 方法分别在各测试之前和之后运行，名称以<code>test_</code>开头的方法都作为测试运行。</p>
<p>setUp方法尝试创建一个测试环境，尽量与正常运行应用所需的环境已知。首先使用测试配置创建应用，然后激活上下文，保证在测试中能够使用 current_app，然后使用create_all创建一个全新的数据库库，数据库和应用上下文在 tearDown中删除。第一个测试确保应用实例存在，第二个确保应用在测试环境中运行。</p>
<p>为了执行单元测试，可以在flasky.py中添加一个自定义命令。<code>flasky.py</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@app.cli.command()</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">test</span>():</span></span><br><span class="line">	<span class="string">&quot;&quot;&quot;Run unit tests.&quot;&quot;&quot;</span></span><br><span class="line">	<span class="keyword">import</span> unittest</span><br><span class="line">	tests = unittest.TestLoader().discover(<span class="string">&#x27;tests&#x27;</span>)</span><br><span class="line">	unittest.TextTestRunner(verbosity=<span class="number">2</span>).run(tests)</span><br></pre></td></tr></table></figure>

<p>app.cli.command装饰器把被装饰的函数名当作命令，调用 unittest包中提供的测试运行程序。使用<code>flask test</code>运行。</p>
<h3 id="创建数据库"><a href="#创建数据库" class="headerlink" title="创建数据库"></a>创建数据库</h3><h3 id="运行应用"><a href="#运行应用" class="headerlink" title="运行应用"></a>运行应用</h3><h1 id="实例：社交博客应用"><a href="#实例：社交博客应用" class="headerlink" title="实例：社交博客应用"></a>实例：社交博客应用</h1><h2 id="用户身份认证"><a href="#用户身份认证" class="headerlink" title="用户身份认证"></a>用户身份认证</h2><p>Flask 有很多身份验证包，这里的方案使用了多个包，通过编写胶水代码让不同的包写作。使用的包：Flask-Login 管理以登录用户的用户会话；Werkzeug 计算密码散列值并进行核对；itsdangerous 生成并核对加密安全令牌。</p>
<p>除了身份验证外，还将用到的扩展：Flask-Mai；Flask-Bootstrap；Flask-WTF。</p>
<h3 id="密码安全性"><a href="#密码安全性" class="headerlink" title="密码安全性"></a>密码安全性</h3><h4 id="使用Werkzeug计算密码散列值"><a href="#使用Werkzeug计算密码散列值" class="headerlink" title="使用Werkzeug计算密码散列值"></a>使用Werkzeug计算密码散列值</h4><p>Werkzeug 中的security模块实现了密码散列值的计算，这一功能的实现只需要两个函数，分别在注册和核对两个阶段。<code>generate_password_hash(password, method=&#39;pbkdf2:sha256&#39;, salt_length=8)</code>，这个函数的输入为原始密码，返回散列的字符串形式供存入数据库。method和salt_length多数情况下可以使用默认值。<code>check_password_hash(hash, password)</code>这个函数的参数是从数据库取回的密码散列值和用户输入的密码，返回True时表示密码正确。</p>
<p>在之前创建的User模型基础上加入密码散列的改动，<code>app/models.py</code>：</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">from werkzeug.security import generate_password_hash, check_password_hash</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span>(<span class="title">db</span>.<span class="title">Model</span>):</span></span><br><span class="line">	<span class="comment"># ...</span></span><br><span class="line">	password_hash = db.Column(db.String(<span class="number">128</span>))</span><br><span class="line">	</span><br><span class="line">	@property</span><br><span class="line">	<span class="function"><span class="keyword">def</span> <span class="title">password</span><span class="params">(<span class="keyword">self</span>)</span></span><span class="symbol">:</span></span><br><span class="line">		raise AttributeError(<span class="string">&#x27;password is not a readable attribute&#x27;</span>)</span><br><span class="line">	</span><br><span class="line">	@password.setter</span><br><span class="line">	<span class="function"><span class="keyword">def</span> <span class="title">password</span><span class="params">(<span class="keyword">self</span>, password)</span></span><span class="symbol">:</span></span><br><span class="line">		<span class="keyword">self</span>.password_hash = generate_password_hash(password)</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">def</span> <span class="title">verify_password</span><span class="params">(<span class="keyword">self</span>, password)</span></span><span class="symbol">:</span></span><br><span class="line">		<span class="keyword">return</span> check_password_hash(<span class="keyword">self</span>.password_hash, password)</span><br></pre></td></tr></table></figure>

<p>添加单元测试，测试最近的改动。<code>test/test_user_model.py</code>：</p>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">import unittest</span><br><span class="line">from app.models import User</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="constructor">UserModelTestCase(<span class="params">unittest</span>.TestCase)</span>:</span><br><span class="line">	def test<span class="constructor">_password_setter(<span class="params">self</span>)</span>:</span><br><span class="line">		u = <span class="constructor">User(<span class="params">password</span> = &#x27;<span class="params">cat</span>&#x27;)</span></span><br><span class="line">		self.<span class="keyword">assert</span><span class="constructor">True(<span class="params">u</span>.<span class="params">password_hash</span> <span class="params">is</span> <span class="params">not</span> None)</span></span><br><span class="line">	def test<span class="constructor">_no_password_getter(<span class="params">self</span>)</span>:</span><br><span class="line">		u = <span class="constructor">User(<span class="params">password</span> = &#x27;<span class="params">cat</span>&#x27;)</span></span><br><span class="line">		<span class="keyword">with</span> self.<span class="keyword">assert</span><span class="constructor">Raises(AtrributeError)</span>:</span><br><span class="line">			u.password</span><br><span class="line">	def test<span class="constructor">_password_verification(<span class="params">self</span>)</span>:</span><br><span class="line">		u = <span class="constructor">User(<span class="params">password</span> = &#x27;<span class="params">cat</span>&#x27;)</span></span><br><span class="line">		self.<span class="keyword">assert</span><span class="constructor">True(<span class="params">u</span>.<span class="params">verify_password</span>(&#x27;<span class="params">cat</span>&#x27;)</span>)</span><br><span class="line">		self.<span class="keyword">assert</span><span class="constructor">False(<span class="params">u</span>.<span class="params">verify_password</span>(&#x27;<span class="params">dog</span>&#x27;)</span>)</span><br><span class="line">	def test<span class="constructor">_password_aslts_are_random(<span class="params">self</span>)</span>:</span><br><span class="line">		u = <span class="constructor">User(<span class="params">password</span>=&#x27;<span class="params">cat</span>&#x27;)</span></span><br><span class="line">		u2 = <span class="constructor">User(<span class="params">password</span>=&#x27;<span class="params">cat</span>&#x27;)</span></span><br><span class="line">		self.<span class="keyword">assert</span><span class="constructor">True(<span class="params">u</span>.<span class="params">password_hash</span> !- <span class="params">u2</span>.<span class="params">password_hash</span>)</span></span><br></pre></td></tr></table></figure>

<h3 id="创建身份验证蓝本"><a href="#创建身份验证蓝本" class="headerlink" title="创建身份验证蓝本"></a>创建身份验证蓝本</h3><p>使用一个名为 auth 的蓝本验证身份，保存在同名python包中。这个蓝本的包构造函数创建蓝本对象，再从views.py模块中导入路由。<code>app/auth/__imit__.py</code>：</p>
<figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Blueprint</span><br><span class="line"></span><br><span class="line"><span class="built_in">auto</span> = Blueprint(<span class="string">&#x27;auth&#x27;</span>, __name__)</span><br><span class="line"><span class="keyword">from</span> . <span class="keyword">import</span> views</span><br></pre></td></tr></table></figure>

<p>views.py 导入蓝本，然后使用蓝本的route 装饰器定义身份与验证相关的路由。这里添加了<code>/login</code>路由，<code>app/auth/views.py</code>：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> render_template</span><br><span class="line"><span class="keyword">from</span> . <span class="keyword">import</span> auth</span><br><span class="line"></span><br><span class="line"><span class="meta">@auth.route(&#x27;/login&#x27;):</span></span><br><span class="line">	<span class="function"><span class="keyword">def</span> <span class="title">login</span>():</span></span><br><span class="line">		<span class="keyword">return</span> render_template(<span class="string">&#x27;auth/login.html&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>auth 蓝本要在 create_app 工厂函数中附加到应用上，<code>app/__init__.py</code>：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">create_app</span>(<span class="params">config_name</span>):</span></span><br><span class="line">	<span class="comment"># ...</span></span><br><span class="line">	<span class="keyword">from</span> .auth <span class="keyword">import</span> auth <span class="keyword">as</span> auth_blueprint</span><br><span class="line">	app.register_blueprint(auth_blueprint, url_prefix=<span class="string">&#x27;/auth&#x27;</span>)</span><br><span class="line">	<span class="keyword">return</span> app</span><br></pre></td></tr></table></figure>

<p>注册蓝本使用的url_prefix时可选参数，注册后蓝本定义的所有路由会加上指定的前缀。例如<code>/lgoin</code>会注册成<code>/auth/login</code>。</p>
<h3 id="使用-Flask-Login-验证身份"><a href="#使用-Flask-Login-验证身份" class="headerlink" title="使用 Flask-Login 验证身份"></a>使用 Flask-Login 验证身份</h3><p>登录后，用户的验证状态要记录在用户会话中。Flask-Login 用于管理用户身份验证系统中的验证状态，不依赖特定的身份验证机制。<code>pip install flask-login</code></p>
<h4 id="准备用于登录的用户模型"><a href="#准备用于登录的用户模型" class="headerlink" title="准备用于登录的用户模型"></a>准备用于登录的用户模型</h4><p>Flask-Login的运行需要应用中有 User对象，User模型必须实现几个属性和方法：</p>
<table>
<thead>
<tr>
<th>属性/方法</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>is_suthenticated</td>
<td>如果用户提供的登录凭据有效则返回True</td>
</tr>
<tr>
<td>is_active</td>
<td>如果允许用户登录，返回True；如果想禁用用户，可以返回False</td>
</tr>
<tr>
<td>is_anonymous</td>
<td>对普通用户返回False，对匿名用户返回True</td>
</tr>
<tr>
<td>get_id()</td>
<td>返回用户的唯一标识符，使用Unicode编码字符串</td>
</tr>
</tbody></table>
<p>这些属性和方法可以在模型类中实现，但是Flask-Login提供了UserMixin类，包含了默认实现，能满足多数需求，修改用户模型，<code>app/models.py</code>:</p>
<figure class="highlight haskell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="title">from</span> flask_login <span class="keyword">import</span> UserMixin</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="type">User</span>(<span class="type">UserMixin</span>, <span class="title">db</span>.<span class="type">Model</span>):</span></span><br><span class="line"><span class="class">	__tablename__ = &#x27;users&#x27;</span></span><br><span class="line"><span class="class">	id = db.<span class="type">Column</span>(<span class="title">db</span>.<span class="type">Integer</span>, <span class="title">primary_key</span>=<span class="type">True</span>)</span></span><br><span class="line"><span class="class">	email = db.<span class="type">Column</span>(<span class="title">db</span>.<span class="type">String(64)</span>, <span class="title">unique</span>=<span class="type">True</span>, <span class="title">index</span>=<span class="type">True</span>)</span></span><br><span class="line"><span class="class">	username = db.<span class="type">Column</span>(<span class="title">db</span>.<span class="type">String(64)</span>, <span class="title">unique</span> = <span class="type">True</span>)</span></span><br><span class="line"><span class="class">	password_hash = db.<span class="type">Column</span>(<span class="title">db</span>.<span class="type">String(128)</span>)</span></span><br><span class="line"><span class="class">	role_id = db.<span class="type">Column</span>(<span class="title">db</span>.<span class="type">Integer</span>, <span class="title">db</span>.<span class="type">ForeignKey</span>(&#x27;<span class="title">roles</span>.<span class="title">id&#x27;</span>))</span></span><br></pre></td></tr></table></figure>

<p>这个示例中，用户使用电子邮件登录。</p>
<p>Flask-Login在应用的工厂函数中初始化，<code>app/__init__.py</code>：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask_login <span class="keyword">import</span> LoginManager</span><br><span class="line"></span><br><span class="line">login_manager = LoginManager()</span><br><span class="line">login_manager.login_view = <span class="string">&#x27;auth.login&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">create_app</span>(<span class="params">config_name</span>):</span></span><br><span class="line">	<span class="comment">#...</span></span><br><span class="line">	login_manager.init_app(app)</span><br><span class="line">	<span class="comment">#...</span></span><br></pre></td></tr></table></figure>

<p>LoginManager 对象的 login_view 属性用于设置登陆页面的端点。匿名用户尝试访问受保护的页面时，Flask-Login将重定向到登陆页面，因为登陆路由在蓝本中定义，所以需要加上蓝本的名称。</p>
<p>Flask-Login 要求应用指定一个函数，在扩展需要从数据库中获取指定标识符对应的用户时调用，<code>app/models.py</code>：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> . <span class="keyword">import</span> login_manager</span><br><span class="line"></span><br><span class="line"><span class="meta">@login_manager.user_loader</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">load_user</span>(<span class="params">user_id</span>):</span></span><br><span class="line">	<span class="keyword">return</span> User.query.get(int(user_id))</span><br></pre></td></tr></table></figure>

<p>login_manager.user_loader 装饰器把这个函数注册给 Flask-Login，在这个扩展需要获取一登陆用户的信息时调用，传入的用户标识符是一个字符串，因此这个函数先把标识符转换成整数，然后传给 Flask-SQLAlchemy 查询，加载用户。正常情况下这个返回值是用户对象，如果失败返回None。</p>
<h4 id="保护路由"><a href="#保护路由" class="headerlink" title="保护路由"></a>保护路由</h4><p>为了保护路由，只让通过身份验证的用户访问，Flask-Login提供了一个login_required 装饰器，可以使用多个装饰器，各装饰器只对随后的装饰器和目标函数起作用。以下例子中，两个装饰器不能对调位置：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask_login <span class="keyword">import</span> login_required</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(&#x27;/secret&#x27;)</span></span><br><span class="line"><span class="meta">@login_required</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">secret</span>():</span></span><br><span class="line">	<span class="keyword">pass</span></span><br></pre></td></tr></table></figure>

<h4 id="添加登录表单"><a href="#添加登录表单" class="headerlink" title="添加登录表单"></a>添加登录表单</h4><p>呈现给用户的登录表单中包含一个用于输入电子邮件地址的文本字段，一个密码字段，一个 记住我 复选框和一个提交按钮，使用Flask-WTF类，<code>/app/auth/forms.py</code>：</p>
<figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask_wtf <span class="keyword">import</span> FlaskForm</span><br><span class="line"><span class="keyword">from</span> wtforms <span class="keyword">import</span> StringField, PasswordField, BoolenField, SubmitField</span><br><span class="line"><span class="keyword">from</span> wtforms.validators <span class="keyword">import</span> DataRequired, Length, Email</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="symbol">LoginForm</span>(<span class="symbol">FlaskForm</span>):</span><br><span class="line">	<span class="symbol">email</span> = <span class="symbol">StringField</span>(&#x27;<span class="symbol">Email</span>&#x27;, <span class="symbol">validators</span>=[<span class="symbol">DataRequired</span>(), <span class="symbol">Length</span>(<span class="symbol">1,<span class="symbol">64</span></span>), <span class="symbol">Email</span>()])</span><br><span class="line">	<span class="symbol">password</span> = <span class="symbol">PasswordField</span>(&#x27;<span class="symbol">Password</span>&#x27;, <span class="symbol">validators</span>=[<span class="symbol">DataRequired</span>()])</span><br><span class="line">	<span class="symbol">remember_me</span> = <span class="symbol">BooleanField</span>(&#x27;<span class="symbol">Keep</span> <span class="symbol">me</span> <span class="symbol">logged</span> <span class="symbol">in</span>&#x27;)</span><br><span class="line">	<span class="symbol">submit</span> = <span class="symbol">SubmitField</span>(&#x27;<span class="symbol">Log</span> <span class="symbol">In</span>&#x27;)</span><br></pre></td></tr></table></figure>

<p>PasswordField 类表示属性为 type=”password” 的 input 元素，BooleanField类表示复选框。电子邮件字段用到了Length，Email，和DataRequired三个验证函数。登录页面使用的模板保存在 auth/login.html中，只需使用Flask-Bootstrap提供的 wtf.quick_form 宏渲染表单即可。base.html中的导航栏可以使用Jinja2条件语句判断当前用户的登陆状态，分别显示 Log In 或 Log out 链接，<code>app/templates/base.html</code>：</p>
<figure class="highlight handlebars"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">ul</span> <span class="attr">class</span>=<span class="string">&quot;nav navbar-nav navbar-right&quot;</span>&gt;</span></span></span><br><span class="line"><span class="xml">	&#123;% if current_user.is_authenticated %&#125;</span></span><br><span class="line"><span class="xml">	<span class="tag">&lt;<span class="name">li</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;</span></span></span><span class="template-variable">&#123;&#123; <span class="name">url_for</span>(<span class="name">&#x27;auth.logout&#x27;</span>) &#125;&#125;</span><span class="xml"><span class="tag"><span class="string">&quot;</span>&gt;</span>Log Out<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span></span><br><span class="line"><span class="xml">	&#123;% else %&#125;</span></span><br><span class="line"><span class="xml">	<span class="tag">&lt;<span class="name">li</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;</span></span></span><span class="template-variable">&#123;&#123; <span class="name">url_for</span>(<span class="name">&#x27;auth.login&#x27;</span>) &#125;&#125;</span><span class="xml"><span class="tag"><span class="string">&quot;</span>&gt;</span>Log In<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span></span><br><span class="line"><span class="xml">	&#123;% endif %&#125;</span></span><br><span class="line"><span class="xml"><span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span></span><br></pre></td></tr></table></figure>

<p>判断条件中的变量 current_user 由Flask-Login定义，在视图函数和模板中自动可用，这个变量的值是当前登录的用户，如果未登录则是一个匿名用户代理对象，它的 isauthenticated 属性是False，，所以可以判断用户是否登录。</p>
<h4 id="登入用户"><a href="#登入用户" class="headerlink" title="登入用户"></a>登入用户</h4><p>实现 login，<code>app/auth/views.py</code>：</p>
<figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> render_template, redirect, request, url_for, flask</span><br><span class="line"><span class="keyword">from</span> flask_login <span class="keyword">import</span> login_user</span><br><span class="line"><span class="keyword">from</span> . <span class="keyword">import</span> auth</span><br><span class="line"><span class="keyword">from</span> ..models <span class="keyword">import</span> <span class="keyword">User</span></span><br><span class="line"><span class="keyword">from</span> .forms <span class="keyword">import</span> LoginForm</span><br><span class="line"></span><br><span class="line">@auth.route(<span class="string">&#x27;/login&#x27;</span>, methods=[<span class="string">&#x27;GET&#x27;</span>, <span class="string">&#x27;POST&#x27;</span>])</span><br><span class="line">def <span class="keyword">login</span>():</span><br><span class="line">	form = LoginFOrm()</span><br><span class="line">	<span class="keyword">if</span> form.validate_on_submit():</span><br><span class="line">		<span class="keyword">user</span> = <span class="keyword">User</span>.query.filter_by(email=form.email.data).first()</span><br><span class="line">		<span class="keyword">if</span> <span class="keyword">user</span> <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">None</span> <span class="keyword">and</span> <span class="keyword">user</span>.verify_password(form.<span class="keyword">password</span>.data)</span><br><span class="line">			login_user(<span class="keyword">user</span>, form.remember_me.data)</span><br><span class="line">			next = request.args.<span class="keyword">get</span>(<span class="string">&#x27;next&#x27;</span>)</span><br><span class="line">			<span class="keyword">if</span> next <span class="keyword">is</span> <span class="keyword">None</span> <span class="keyword">or</span> <span class="keyword">not</span> next.startswith(<span class="string">&#x27;/&#x27;</span>):</span><br><span class="line">				next = url_for(<span class="string">&#x27;main.index&#x27;</span>)</span><br><span class="line">			<span class="keyword">return</span> redirect(next)</span><br><span class="line">		flash(<span class="string">&#x27;Invalid username or password.&#x27;</span>)</span><br><span class="line">	<span class="keyword">return</span> render_template(<span class="string">&#x27;auth/login.html&#x27;</span>, form=form)</span><br></pre></td></tr></table></figure>

<p>修改后的模板，<code>app/templates/auth/login.html</code>：</p>
<figure class="highlight django"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="template-tag">&#123;% <span class="name"><span class="name">extends</span></span> &quot;base.html&quot; %&#125;</span></span><br><span class="line"><span class="template-tag">&#123;% <span class="name">import</span> &quot;bootstrap/wtf.html&quot; <span class="keyword">as</span> wtf %&#125;</span></span><br><span class="line"><span class="template-tag">&#123;% <span class="name"><span class="name">block</span></span> title %&#125;</span><span class="xml">Flasky - Login</span><span class="template-tag">&#123;% <span class="name"><span class="name">endblock</span></span> %&#125;</span></span><br><span class="line"><span class="template-tag">&#123;% <span class="name"><span class="name">block</span></span> page_content %&#125;</span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;page-header&quot;</span>&gt;</span></span></span><br><span class="line"><span class="xml">	<span class="tag">&lt;<span class="name">h1</span>&gt;</span>Login<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;col-md-4&quot;</span>&gt;</span></span></span><br><span class="line"><span class="xml">	</span><span class="template-variable">&#123;&#123; wtf.quick_form(form) &#125;&#125;</span></span><br><span class="line"><span class="xml"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="template-tag">&#123;% <span class="name"><span class="name">endblock</span></span> %&#125;</span></span><br></pre></td></tr></table></figure>

<h4 id="登出用户"><a href="#登出用户" class="headerlink" title="登出用户"></a>登出用户</h4><p>退出路由的实现，<code>app/auth/views.py</code>：</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">from flask_login <span class="keyword">import</span> logout_user, login_required</span><br><span class="line"></span><br><span class="line"><span class="variable">@auth</span>.route(<span class="string">&#x27;/logout&#x27;</span>)</span><br><span class="line"><span class="variable">@login_required</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">loggout</span></span>()<span class="symbol">:</span></span><br><span class="line">	logout_user()</span><br><span class="line">	flash(<span class="string">&#x27;You have benn logged gout.&#x27;</span>)</span><br><span class="line">	<span class="keyword">return</span> redirect(url_for(<span class="string">&#x27;main.index&#x27;</span>))</span><br></pre></td></tr></table></figure>

<h4 id="理解-Flask-Login-的运作方式"><a href="#理解-Flask-Login-的运作方式" class="headerlink" title="理解 Flask-Login 的运作方式"></a>理解 Flask-Login 的运作方式</h4><p>用户登录过程涉及的操作：</p>
<ol>
<li>点击 Log In 链接，访问 /auth/login，处理这个URL的函数返回登陆表单模板。</li>
<li>用户输入用户名和密码，点击提交，调用相同的处理函数，但这一次是POST请求。处理函数会验证表单提交的凭据，调用Flask-Login的 login_user函数，登入用户。login_user函数把用户ID以字符串形式写入用户会话。视图函数重定向到首页。</li>
<li>浏览器收到重定向，请求首页。调用首页的视图函数，渲染模板，出现对 current_user的引用。这个请求没有给上下文变量 current_user 赋值，因此调用Flask-Login内部的 <code>_get_user</code>函数，找出用户是谁。<code>_get_user</code>检查用户会话中有没有用户ID，如果没有，返回一个Flask-Login的 AnonymousUser实例，如果由，调用应用中使用 user_load 装饰器注册的函数，传入用户ID。应用中的 user_ loader 从数据库中读取用户并返回。Flask-login把它赋值给当前请求的 current_user上下文变量。模板接收它。</li>
</ol>
<p>使用 login_required 装饰器装饰的试图函数将使用 current_user 上下文变量判断 current_user.is_authenticated 表达式是否为 True 。logout_user 函数比较简单，直接从用户会话中删除用户ID。</p>
<h4 id="登录测试"><a href="#登录测试" class="headerlink" title="登录测试"></a>登录测试</h4><p>为验证登录功能可用，可以更新首页，使用已登录用户的名字显示一个欢迎信息。<code>app/templates/index.html</code>：</p>
<figure class="highlight django"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="xml">Hello,</span></span><br><span class="line"><span class="template-tag">&#123;% <span class="name"><span class="name">if</span></span> current_user.is_autenticated %&#125;</span></span><br><span class="line"><span class="xml">	</span><span class="template-variable">&#123;&#123; current_user.username &#125;&#125;</span></span><br><span class="line"><span class="template-tag">&#123;% <span class="name"><span class="name">else</span></span> %&#125;</span></span><br><span class="line"><span class="xml">	Stranger</span></span><br><span class="line"><span class="template-tag">&#123;% <span class="name"><span class="name">endif</span></span> %&#125;</span><span class="xml">!</span></span><br></pre></td></tr></table></figure>

<p>因为未实现注册功能，目前只能在shell中注册新用户。</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">flask shell</span><br><span class="line">u = User(<span class="attribute">email</span>=<span class="string">&#x27;john@example.com&#x27;</span>, <span class="attribute">username</span>=<span class="string">&#x27;john&#x27;</span>, <span class="attribute">password</span>=<span class="string">&#x27;cat&#x27;</span>)</span><br><span class="line">db.session.<span class="builtin-name">add</span>(u)</span><br><span class="line">db.session.commit()</span><br></pre></td></tr></table></figure>

<p>访问首页可以看到结果</p>
<h3 id="注册新用户"><a href="#注册新用户" class="headerlink" title="注册新用户"></a>注册新用户</h3><p>如果新用户想成为应用的成员，必须在应用中注册。这样应用才能识别并登入用户。登录页面要显示一个注册页面的链接，让用户输入电子邮件地址，用户名和密码。</p>
<h4 id="添加用户注册表单"><a href="#添加用户注册表单" class="headerlink" title="添加用户注册表单"></a>添加用户注册表单</h4><p><code>app/auth/forms.py</code>：</p>
<figure class="highlight haskell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="title">from</span> flask_wtf <span class="keyword">import</span> FlaskForm</span><br><span class="line"><span class="title">from</span> wtforms <span class="keyword">import</span> StringField, PasswordField, BooleanField, SubmitField</span><br><span class="line"><span class="title">from</span> wtforms <span class="keyword">import</span> ValidationError</span><br><span class="line"><span class="title">from</span> ..models <span class="keyword">import</span> User</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="type">RegistrationForm</span>(<span class="type">FlaskForm</span>):</span></span><br><span class="line"><span class="class">	email = <span class="type">StringField</span>(&#x27;<span class="type">Email</span>&#x27;, <span class="title">validators</span>=[<span class="type">DataRequired</span>(), <span class="type">Length</span>(1,64), <span class="type">Email</span>()])</span></span><br><span class="line"><span class="class">	username = <span class="type">StringField</span>(&#x27;<span class="type">Username</span>&#x27;, <span class="title">validators</span>=[<span class="type">DataRequired</span>(), <span class="type">Length</span>(1,64), </span></span><br><span class="line"><span class="class">		<span class="type">Regexp</span>(&#x27;^[<span class="type">A</span>-<span class="type">Za</span>-<span class="title">z</span>][<span class="type">A</span>-<span class="type">Za</span>-<span class="title">z0</span>-9]*$&#x27;, 0, &#x27;<span class="type">Username</span> <span class="title">must</span> <span class="title">have</span> <span class="title">only</span> <span class="title">letters</span>, <span class="title">numbers</span>, <span class="title">dots</span> <span class="title">or</span> &#x27;</span></span><br><span class="line"><span class="class">		&#x27;<span class="title">underscores&#x27;</span>)])</span></span><br><span class="line"><span class="class">	password = <span class="type">PasswordField</span>(&#x27;<span class="type">Password</span>&#x27;, <span class="title">validators</span>=[<span class="type">DataRequired</span>(), <span class="type">EqualTo</span>(&#x27;<span class="title">password2&#x27;</span>, <span class="title">message</span>=&#x27;<span class="type">Password</span> <span class="title">must</span> <span class="title">math</span>.&#x27;)])</span></span><br><span class="line"><span class="class">	password2 = <span class="type">PasswordField</span>(&#x27;<span class="type">Confirm</span> <span class="title">password&#x27;</span>, <span class="title">validators</span>=[<span class="type">DataRequired</span>()])</span></span><br><span class="line"><span class="class">	submit = <span class="type">SubmitField</span>(&#x27;<span class="type">Register</span>&#x27;)</span></span><br><span class="line"><span class="class">	def validate_email(<span class="title">self</span>, <span class="title">field</span>):</span></span><br><span class="line"><span class="class">		if <span class="type">User</span>.query.filter_by(<span class="title">email</span>=<span class="title">field</span>.<span class="title">data</span>).first()</span></span><br><span class="line"><span class="class">			raise <span class="type">ValidationError</span>(&#x27;<span class="type">Email</span> <span class="title">already</span> <span class="title">registered</span>.&#x27;)</span></span><br><span class="line"><span class="class">	def validate_username(<span class="title">self</span>, <span class="title">field</span>):</span></span><br><span class="line"><span class="class">		if <span class="type">User</span>.query.filter_by(<span class="title">username</span>=<span class="title">field</span>.<span class="title">data</span>).first():</span></span><br><span class="line"><span class="class">			raise <span class="type">ValidatioinError</span>(&#x27;<span class="type">Username</span> <span class="title">already</span> <span class="title">in</span> <span class="title">use</span>.&#x27;)</span></span><br></pre></td></tr></table></figure>

<p>这个表单使用WTForms提供的Regexp验证函数，后面两个参数分别是正则表达式标志和验证失败显示的错误信息。EqualTo验证函数检查两个字段是否一致，输入为另一个字段。还含有两个自定义验证函数，以方法方式实现。如果表单定义了<code>validate_</code>开头并且后面跟着字段名的方法，这个方法就和常规的验证函数一起使用。这里为email 和 username 定义了验证函数，确保数据库中没有出现过。自定义验证函数表示验证失败可以跑出 ValidationError 异常，参数是错误信息。</p>
<p>显示这个表单的模板是 <code>app/templates/auth/register.html</code>，使用<code>wtf.quick_form</code>渲染表单，登录页面要显示一个指向注册页面的链接，<code>app/templates/auth/login.html</code>：</p>
<figure class="highlight handlebars"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">p</span>&gt;</span></span></span><br><span class="line"><span class="xml">	New user?</span></span><br><span class="line"><span class="xml">	<span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;</span></span></span><span class="template-variable">&#123;&#123; <span class="name">url_for</span>(<span class="name">&#x27;auth.register&#x27;</span>) &#125;&#125;</span><span class="xml"><span class="tag"><span class="string">&quot;</span>&gt;</span></span></span><br><span class="line"><span class="xml">		Click here to register</span></span><br><span class="line"><span class="xml">	<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;/<span class="name">p</span>&gt;</span></span></span><br></pre></td></tr></table></figure>

<h4 id="注册新用户-1"><a href="#注册新用户-1" class="headerlink" title="注册新用户"></a>注册新用户</h4><p><code>app/auth/views.py</code>：</p>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">@auth.route(&#x27;/register&#x27;, methods=<span class="literal">[&#x27;GET&#x27;, &#x27;POST&#x27;]</span>)</span><br><span class="line">def register<span class="literal">()</span>:</span><br><span class="line">	form = <span class="constructor">RegistrationForm()</span></span><br><span class="line">	<span class="keyword">if</span> form.validate<span class="constructor">_on_submit()</span>:</span><br><span class="line">		user = <span class="constructor">User(<span class="params">email</span>=<span class="params">form</span>.<span class="params">email</span>.<span class="params">data</span>, <span class="params">username</span>=<span class="params">form</span>.<span class="params">username</span>.<span class="params">data</span>, <span class="params">password</span>=<span class="params">form</span>.<span class="params">password</span>.<span class="params">data</span>)</span></span><br><span class="line">	db.session.add(User)</span><br><span class="line">	db.session.commit<span class="literal">()</span></span><br><span class="line">	flash(&#x27;You can now login.&#x27;)</span><br><span class="line">	return redirect(url<span class="constructor">_for(&#x27;<span class="params">auth_login</span>&#x27;)</span>)</span><br><span class="line">return render<span class="constructor">_template(&#x27;<span class="params">auth</span><span class="operator">/</span><span class="params">register</span>.<span class="params">html</span>&#x27;, <span class="params">form</span>=<span class="params">form</span>)</span></span><br></pre></td></tr></table></figure>

<h3 id="确认账户"><a href="#确认账户" class="headerlink" title="确认账户"></a>确认账户</h3><p>有时需要确认用户提供的信息是否正确，常见于检查电子邮件地址。通过向提供的邮箱发送确认邮件，要求用户点击一个包含确认令牌的特殊URL可以确认。</p>
<h4 id="使用-itsdangerous-生成确认令牌"><a href="#使用-itsdangerous-生成确认令牌" class="headerlink" title="使用 itsdangerous 生成确认令牌"></a>使用 itsdangerous 生成确认令牌</h4><figure class="highlight haskell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="title">flask</span> shell</span><br><span class="line"><span class="title">from</span> itsdangerous <span class="keyword">import</span> TimedJSONWebSignatureSerialize <span class="keyword">as</span> Serializer</span><br><span class="line"><span class="title">s</span> = <span class="type">Serializer</span>(app.config[&#x27;<span class="type">SECRET_KEY&#x27;</span>], expires_in=<span class="number">3600</span>)</span><br><span class="line"><span class="title">token</span> = s.dumps(&#123;&#x27;confirm&#x27;: <span class="number">23</span>&#125;)</span><br><span class="line"><span class="title">token</span></span><br><span class="line"><span class="meta"># evJh........</span></span><br><span class="line"><span class="class"><span class="keyword">data</span> = s.loads(<span class="title">token</span>)</span></span><br><span class="line"><span class="class"><span class="keyword">data</span></span></span><br><span class="line"><span class="meta"># &#123;&#x27;confirm&#x27;: 23&#125;</span></span><br></pre></td></tr></table></figure>

<p>itsdangerous 提供多种生成令牌的方法，其中 TimedJSONWebSignatureSerializer 正常具有过期时间的 JSON Web签名（JWS），构造函数接受的参数是一个密钥，可以使用 SECRET_KEY 设置。</p>
<p>dumps 方法为指定的数据生成一个加密签名，然后对数据和签名进行序列化，生成令牌字符串。expires_in参数设置过期时间，单位是秒。</p>
<p>loads 方法解码令牌，参数是令牌字符串，检验签名和过期时间。如果都有效，返回原始数据，否则抛出异常。这个功能可以添加到User模型中。<code>app/models.py</code>：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> itsdangerous <span class="keyword">import</span> TimedJSONWebSignatureSerializer <span class="keyword">as</span> Serializer</span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> current_app</span><br><span class="line"><span class="keyword">from</span> . <span class="keyword">import</span> db</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span>(<span class="params">UserMixin, db.Model</span>):</span></span><br><span class="line">	<span class="comment"># ...</span></span><br><span class="line">	confirmed = db.Column(db.Boolean, default=<span class="literal">False</span>)</span><br><span class="line">	<span class="function"><span class="keyword">def</span> <span class="title">generate_confirmation_token</span>(<span class="params">self, expiration=<span class="number">3600</span></span>):</span></span><br><span class="line">		s = Serializer(current_app.config[<span class="string">&#x27;SECRET_KEY&#x27;</span>], expiration)</span><br><span class="line">		<span class="keyword">return</span> s.dumps(&#123;<span class="string">&#x27;confirm&#x27;</span>: self.id&#125;).decode(<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line">	<span class="function"><span class="keyword">def</span> <span class="title">confirm</span>(<span class="params">self, token</span>):</span></span><br><span class="line">		s = Serializer(current_app.config[<span class="string">&#x27;SECRET_KEY&#x27;</span>])</span><br><span class="line">		<span class="keyword">try</span>:</span><br><span class="line">			data = s.loads(token.encode(<span class="string">&#x27;utf-8&#x27;</span>))</span><br><span class="line">		<span class="keyword">except</span>:</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">		<span class="keyword">if</span> data.get(<span class="string">&#x27;confirm&#x27;</span>) != self.id</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">		self.confirmed = <span class="literal">True</span></span><br><span class="line">		db.session.add(self)</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">True</span></span><br></pre></td></tr></table></figure>

<h4 id="发送确认邮件"><a href="#发送确认邮件" class="headerlink" title="发送确认邮件"></a>发送确认邮件</h4><p>当前的<code>/register</code>路由把新用户添加到数据库中之后会重定向到<code>/index</code>，在这之前需要发送确认邮件，<code>app/auth/views.py</code>：</p>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">from ..email import send_email</span><br><span class="line"></span><br><span class="line">@app.route(&#x27;/register&#x27;, methods=<span class="literal">[&#x27;GET&#x27;, &#x27;POST&#x27;]</span>)</span><br><span class="line">def register<span class="literal">()</span>:</span><br><span class="line">	form = <span class="constructor">RegistrationForm()</span></span><br><span class="line">	<span class="keyword">if</span> form.validate<span class="constructor">_on_submit()</span>:</span><br><span class="line">		# ...</span><br><span class="line">		db.session.add(User)</span><br><span class="line">		db.session.conmmit<span class="literal">()</span></span><br><span class="line">		token = user.generate<span class="constructor">_cofirmation_token()</span></span><br><span class="line">		send<span class="constructor">_email(<span class="params">user</span>.<span class="params">email</span>, &#x27;Confirm Your Account&#x27;, &#x27;<span class="params">auth</span><span class="operator">/</span><span class="params">email</span><span class="operator">/</span><span class="params">confirm</span>&#x27;, <span class="params">user</span>=<span class="params">user</span>, <span class="params">token</span>=<span class="params">token</span>)</span></span><br><span class="line">		flash(&#x27;A confirmation email has been sent <span class="keyword">to</span> your&#x27;)</span><br></pre></td></tr></table></figure>

<p>身份验证蓝本使用的电子邮件模板保存在 templates/auth/email 目录中，以便与HTML模板区分。一个电子邮件需要两个模板，分别用于渲染纯文本正文和HTML正文。例如以下纯文本模板，<code>app/templates/auth/email/confirm.txt</code>：</p>
<figure class="highlight handlebars"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="xml">Dear </span><span class="template-variable">&#123;&#123; <span class="name">user.username</span> &#125;&#125;</span></span><br><span class="line"><span class="xml">Welcome to Flasky!</span></span><br><span class="line"><span class="xml">To confirm your account please click on the following link:</span></span><br><span class="line"><span class="template-variable">&#123;&#123; <span class="name">url_for</span>(<span class="name">&#x27;auth.confirm&#x27;</span>, <span class="attr">token</span>=token, <span class="attr">_external</span>=<span class="literal">True</span>) &#125;&#125;</span></span><br></pre></td></tr></table></figure>

<p>确认账户的视图函数，<code>app/auth/views.py</code>：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask_login <span class="keyword">import</span> current_user</span><br><span class="line"></span><br><span class="line"><span class="meta">@auth.route(&#x27;/confirm/&lt;token&gt;&#x27;):</span></span><br><span class="line"><span class="meta">@login_required</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">confirm</span>(<span class="params">token</span>):</span></span><br><span class="line">	<span class="keyword">if</span> current_user.confirmed:</span><br><span class="line">		<span class="keyword">return</span> redirect(url_for(<span class="string">&#x27;main.index&#x27;</span>))</span><br><span class="line">	<span class="keyword">if</span> current_user.confirm(token):</span><br><span class="line">		db.session.commit()</span><br><span class="line">		flash(<span class="string">&#x27;You have confirmed your account.&#x27;</span>)</span><br><span class="line">	<span class="keyword">else</span>:</span><br><span class="line">		flash(<span class="string">&#x27;The confirmation link is invalid or has expired.&#x27;</span>)</span><br><span class="line">	<span class="keyword">return</span> redirect(url_for(<span class="string">&#x27;main.index&#x27;</span>))</span><br></pre></td></tr></table></figure>

<p>由于令牌确认完全在User模型中完成，因此视图函数只需要调用 confirm 方法即可，再根据确认结果显示不同的信息。确认成功后，User模型中 confirmed属性的值会修改并添加到会话中，然后提交数据库会话。</p>
<p>各个应用可以自行决定用户确认账户之前可以做哪些操作，比如允许未经确认的用户登录，但只显示一个界面，要求访问之前确认账户。这一步可以通过 Flask 提供的 before_request 钩子完成，对于蓝本来说，before_request 钩子只能应用到属于蓝本的请求上。如果想在蓝本中使用针对应用全局请求的钩子，必须使用 before_app_request装饰器。<code>app/auth/views.py</code>：</p>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">@auth</span>.before_app_request</span><br><span class="line">def before_request():</span><br><span class="line">	if current_user.is_authenticated \</span><br><span class="line">		and not current_user.confirmed \</span><br><span class="line">		and request.blueprint != <span class="string">&#x27;auth&#x27;</span> \</span><br><span class="line">		and request.endpoint != <span class="string">&#x27;static&#x27;</span>:</span><br><span class="line">		return redirect(url_for(<span class="string">&#x27;auth.unconfirmed&#x27;</span>))</span><br><span class="line"></span><br><span class="line"><span class="variable">@auth</span>.route(<span class="string">&#x27;/unconfirmed&#x27;</span>)</span><br><span class="line">def unconfirmed():</span><br><span class="line">	if current_user.is_anonymous or current_user.<span class="attribute">confirmed</span>:</span><br><span class="line">		return redirect(url_for(<span class="string">&#x27;main.index&#x27;</span>))</span><br><span class="line">	return render_template(<span class="string">&#x27;auth/confirmed.html&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>用户已登录，未确认并且请求的URL不在身份验证蓝本中，不是对静态文件的请求，要赋予用户访问路由的权限时，before_app_request 会拦截请求，重定向到<code>auth/unconfirmed</code>。</p>
<p>重新发送账户确认邮件，<code>app/auth/views.py</code>：</p>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">@auth</span>.route(<span class="string">&#x27;/confirm&#x27;</span>)</span><br><span class="line"><span class="variable">@login_required</span></span><br><span class="line">def resend_confirmation():</span><br><span class="line">	token = current_user.generate_confirmation_token()</span><br><span class="line">	send_email(current_user.email, <span class="string">&#x27;Confirm Your Account&#x27;</span>, </span><br><span class="line">		<span class="string">&#x27;auth/email/confirm&#x27;</span>, user=current_user, token=token)</span><br><span class="line">	flash(<span class="string">&#x27;A new confirmation email has been sent to you.&#x27;</span>)</span><br><span class="line">	return redirect(url_for(<span class="string">&#x27;main.index&#x27;</span>))</span><br></pre></td></tr></table></figure>

<h3 id="管理账户"><a href="#管理账户" class="headerlink" title="管理账户"></a>管理账户</h3><p>拥有应用账户的用户有时可能需要修改账户信息，也可添加功能。</p>
<h2 id="用户角色"><a href="#用户角色" class="headerlink" title="用户角色"></a>用户角色</h2><p>实现方式结合了分立的角色和权限，赋予用户分立的角色，但是哥哥角色都通过权限列表定义允许用户执行的操作。</p>
<h3 id="角色在数据库中的表示"><a href="#角色在数据库中的表示" class="headerlink" title="角色在数据库中的表示"></a>角色在数据库中的表示</h3><p>改进后的Role模型，<code>app/models.py</code>：</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">class Role(db.Model):</span><br><span class="line">	__tablename__ = <span class="string">&#x27;roles&#x27;</span></span><br><span class="line">	id = db.Column(db.Integer, <span class="attribute">primary_key</span>=<span class="literal">True</span>)</span><br><span class="line">	name = db.Column(db.String(64), <span class="attribute">unique</span>=<span class="literal">True</span>)</span><br><span class="line"><span class="built_in">	default </span>= db.Column(db.Boolean, <span class="attribute">default</span>=<span class="literal">False</span>, <span class="attribute">index</span>=<span class="literal">True</span>)</span><br><span class="line">	permissions = db.Column(db.Integer)</span><br><span class="line"><span class="built_in">	users </span>= db.reationship(<span class="string">&#x27;User&#x27;</span>, <span class="attribute">backref</span>=<span class="string">&#x27;role&#x27;</span>, <span class="attribute">lazy</span>=<span class="string">&#x27;dynamic&#x27;</span>)</span><br><span class="line">	</span><br><span class="line">	def __init__(self, **kwargs):</span><br><span class="line">		super(Role, self).__init__(**kwargs)</span><br><span class="line">		<span class="keyword">if</span> self.permissions is None:</span><br><span class="line">			self.permissions = 0</span><br></pre></td></tr></table></figure>

<p>这里新增了 default 字段，这是注册新用户时赋予的角色，只能有一个角色的这个字段为 True，因为应用在 roles 表中搜索默认角色，因此设置了索引。另一处改动是增加了 permissions 字段，SQLAlchemy 默认把这个字段的值设为None，因此添加了一个类构造函数，默认把 permissions设置为0。各操作所需的权限在不同的应用中是不一样的，定义权限：</p>
<table>
<thead>
<tr>
<th>操作</th>
<th>权限名</th>
<th>权限值</th>
</tr>
</thead>
<tbody><tr>
<td>关注用户</td>
<td>FOLLOW</td>
<td>1</td>
</tr>
<tr>
<td>在他人的文章中发表评论</td>
<td>COMMENT</td>
<td>2</td>
</tr>
<tr>
<td>写文章</td>
<td>WRITE</td>
<td>4</td>
</tr>
<tr>
<td>管理他人发表的评论</td>
<td>MODERATE</td>
<td>8</td>
</tr>
<tr>
<td>管理员权限</td>
<td>ADMIN</td>
<td>16</td>
</tr>
</tbody></table>
<p>使用2的幂表示权限可以方便的组合权限。<code>app/models.py</code>：</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Permission</span>:</span></span><br><span class="line">	FOLLOW = <span class="number">1</span></span><br><span class="line">	COMMENT = <span class="number">2</span></span><br><span class="line">	WRITE = <span class="number">4</span></span><br><span class="line">	MODERATE = <span class="number">8</span></span><br><span class="line">	ADMIN = <span class="number">16</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Role</span>(<span class="title">db</span>.<span class="title">Model</span>):</span></span><br><span class="line">	<span class="comment"># ...</span></span><br><span class="line">	<span class="function"><span class="keyword">def</span> <span class="title">add_permission</span><span class="params">(<span class="keyword">self</span>, perm)</span></span><span class="symbol">:</span></span><br><span class="line">		<span class="keyword">if</span> <span class="keyword">not</span> <span class="keyword">self</span>.hash_permission(perm)<span class="symbol">:</span></span><br><span class="line">			<span class="keyword">self</span>.permissions += perm</span><br><span class="line">	<span class="function"><span class="keyword">def</span> <span class="title">remove_permission</span><span class="params">(<span class="keyword">self</span>, perm)</span></span><span class="symbol">:</span></span><br><span class="line">		<span class="keyword">if</span> <span class="keyword">self</span>.has_permission(perm)<span class="symbol">:</span></span><br><span class="line">			<span class="keyword">self</span>.permissions -= perm</span><br><span class="line">	<span class="function"><span class="keyword">def</span> <span class="title">reset_permissions</span><span class="params">(<span class="keyword">self</span>)</span></span><span class="symbol">:</span></span><br><span class="line">		<span class="keyword">self</span>.permissions = <span class="number">0</span></span><br><span class="line">	<span class="function"><span class="keyword">def</span> <span class="title">has_permission</span><span class="params">(<span class="keyword">self</span>, perm)</span></span><span class="symbol">:</span></span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">self</span>.permissions &amp; perm == perm</span><br></pre></td></tr></table></figure>

<p>用户角色和权限组合的定义：</p>
<table>
<thead>
<tr>
<th>用户角色</th>
<th>权限</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>匿名</td>
<td>无</td>
<td>未登录用户</td>
</tr>
<tr>
<td>用户</td>
<td>FOLLOW, COMMENT, WRITE</td>
<td>新用户默认角色</td>
</tr>
<tr>
<td>协管员</td>
<td>FOLLOW, COMMENT, WRITE, MODERATE</td>
<td>增加管理其他用户评论的权限</td>
</tr>
<tr>
<td>管理员</td>
<td>FOLLOW, COMMENT, WRITE, MODERATE, ADMIN</td>
<td>具有所有权限，包括修改其他用户所属角色</td>
</tr>
</tbody></table>
<p>可以在Role类中添加一个类方法，将角色添加到数据库。既方便测试，也方便部署到生产环境。<code>app/models.py</code></p>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="constructor">Role(<span class="params">db</span>.Model)</span>:</span><br><span class="line">	# .</span><br><span class="line">	@staticmethod</span><br><span class="line">	def insert<span class="constructor">_roles()</span>:</span><br><span class="line">		roles = &#123;</span><br><span class="line">			&#x27;User&#x27;: <span class="literal">[P<span class="identifier">ermission</span>.FOLLOW, P<span class="identifier">ermission</span>.COMMENT, P<span class="identifier">ermission</span>.WRITE]</span>,</span><br><span class="line">			&#x27;Moderator&#x27;: <span class="literal">[P<span class="identifier">ermission</span>.FOLLOW, P<span class="identifier">ermission</span>.COMMENT, P<span class="identifier">ermission</span>.WRITE, P<span class="identifier">ermission</span>.MODERATE]</span>,</span><br><span class="line">			&#x27;Administrator&#x27;: <span class="literal">[P<span class="identifier">ermission</span>.FOLLOW, P<span class="identifier">ermission</span>.COMMENT, P<span class="identifier">ermission</span>.WRITE, P<span class="identifier">ermission</span>.MODERATE, P<span class="identifier">ermission</span>.ADMIN]</span></span><br><span class="line">			&#125;</span><br><span class="line">			default_role = &#x27;User&#x27;</span><br><span class="line">			<span class="keyword">for</span> r <span class="keyword">in</span> roles:</span><br><span class="line">				role = <span class="module-access"><span class="module"><span class="identifier">Role</span>.</span></span>query.filter<span class="constructor">_by(<span class="params">name</span>=<span class="params">r</span>)</span>.first<span class="literal">()</span></span><br><span class="line">				<span class="keyword">if</span> role is None:</span><br><span class="line">					role = <span class="constructor">Role(<span class="params">name</span>=<span class="params">r</span>)</span></span><br><span class="line">				role.reset<span class="constructor">_permission()</span></span><br><span class="line">				<span class="keyword">for</span> perm <span class="keyword">in</span> roles<span class="literal">[<span class="identifier">r</span>]</span>:</span><br><span class="line">					role.add<span class="constructor">_permission(<span class="params">perm</span>)</span></span><br><span class="line">				role.default = (role.name<span class="operator"> == </span>default_role)</span><br><span class="line">				db.session.add(role)</span><br><span class="line">			db.session.commit<span class="literal">()</span></span><br></pre></td></tr></table></figure>

<p>insert_roles 函数不直接创建角色对象，通过角色名查找现有的角色，然后进行更新。没有角色时创建新角色对象。它是一个静态方法，不需要创建对象，直接在类上调用，例如<code>Role.insert_roles()</code>，静态方法参数中没有 self。</p>
<h3 id="赋予角色"><a href="#赋予角色" class="headerlink" title="赋予角色"></a>赋予角色</h3><p>用户注册账户时应被赋予用户角色，管理员在最开始就应该赋予 管理员 角色，由保存在设置变量FLASKY_ADMIN 中的电子邮件地址识别，<code>app/models.py</code>：</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span>(<span class="title">UserMixin</span>, <span class="title">db</span>.<span class="title">Model</span>):</span></span><br><span class="line">	<span class="comment"># ...</span></span><br><span class="line">	<span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(<span class="keyword">self</span>, **args)</span></span><span class="symbol">:</span></span><br><span class="line">		<span class="keyword">super</span>(User, <span class="keyword">self</span>).__init(**kwargs)</span><br><span class="line">		<span class="keyword">if</span> <span class="keyword">self</span>.role is <span class="symbol">None:</span></span><br><span class="line">			<span class="keyword">if</span> <span class="keyword">self</span>.email == current_app.config[<span class="string">&#x27;FLASKY_ADMIN&#x27;</span>]<span class="symbol">:</span></span><br><span class="line">				<span class="keyword">self</span>.role = Role.query.filter_by(name=<span class="string">&#x27;Administrator&#x27;</span>).first()</span><br><span class="line">			<span class="keyword">if</span> <span class="keyword">self</span>.role is <span class="symbol">None:</span></span><br><span class="line">				<span class="keyword">self</span>.role = Role.query.filter_by(default=True).first</span><br><span class="line"><span class="comment"># ...</span></span><br></pre></td></tr></table></figure>

<p>User 类的构造函数先调用积累的构造函数，如果没有定义角色，用电子邮件确定角色。</p>
<h3 id="检验角色"><a href="#检验角色" class="headerlink" title="检验角色"></a>检验角色</h3><p>为了简化角色和权限的实现过程，可在User模型中添加辅助方法，检查权限，可以委托前面添加的权限管理方法，<code>app/models.py</code>：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask_login <span class="keyword">import</span> UserMixin, AnonymousUserMixin</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span>(<span class="params">UserMixin, db.Model</span>):</span></span><br><span class="line">	<span class="comment"># ...</span></span><br><span class="line">	<span class="function"><span class="keyword">def</span> <span class="title">can</span>(<span class="params">self, perm</span>):</span></span><br><span class="line">		<span class="keyword">return</span> self.role <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span> <span class="keyword">and</span> self.role.hase_permission(perm)</span><br><span class="line">	<span class="function"><span class="keyword">def</span> <span class="title">is_administrator</span>(<span class="params">self</span>):</span></span><br><span class="line">		<span class="keyword">return</span> self.can(Permission.ADMIN)</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AnonymousUser</span>(<span class="params">AnonymousUserMixin</span>):</span></span><br><span class="line">	<span class="function"><span class="keyword">def</span> <span class="title">can</span>(<span class="params">self, permissions</span>):</span></span><br><span class="line">		<span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">	<span class="function"><span class="keyword">def</span> <span class="title">is_administrator</span>(<span class="params">self</span>):</span></span><br><span class="line">		<span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">login_manager.anonymous_user = AnonymousUser</span><br></pre></td></tr></table></figure>

<p>如果想让视图函数只对由特定权限的用户开放，可以使用自定义装饰器。<code>app/decorators.py</code>：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> functools <span class="keyword">import</span> wraps</span><br><span class="line"><span class="keyword">from</span> flask_import abort</span><br><span class="line"><span class="keyword">from</span> flask_login <span class="keyword">import</span> current_user</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">permission_required</span>(<span class="params">permission</span>):</span></span><br><span class="line">	<span class="function"><span class="keyword">def</span> <span class="title">decorator</span>(<span class="params">f</span>):</span></span><br><span class="line"><span class="meta">		@wraps(f)</span></span><br><span class="line">		<span class="function"><span class="keyword">def</span> <span class="title">decorated_funtion</span>(<span class="params">*args, **kwargs</span>):</span></span><br><span class="line">			<span class="keyword">if</span> not_current_user.can(permission):</span><br><span class="line">				abortt(<span class="number">403</span>)</span><br><span class="line">			<span class="keyword">return</span> f(*args, **kwargs)</span><br><span class="line">		retrun decorated_funtion</span><br><span class="line">	<span class="keyword">return</span> decorator</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">admin_required</span>(<span class="params">f</span>):</span></span><br><span class="line">	<span class="keyword">return</span> permission_required(Permission.ADMIN)(f)</span><br></pre></td></tr></table></figure>

<p>装饰器的使用：</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">from .decorators import admin_required, permission_required</span><br><span class="line"></span><br><span class="line">@main.route(<span class="string">&#x27;/admin&#x27;</span>)</span><br><span class="line">@login_required</span><br><span class="line">@admin_required</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">for_admins_only</span><span class="params">()</span></span><span class="symbol">:</span></span><br><span class="line">	<span class="keyword">return</span> <span class="string">&quot;For administrators&quot;</span></span><br><span class="line">@main.route(<span class="string">&#x27;/moderate&#x27;</span>)</span><br><span class="line">@login_required</span><br><span class="line">@permission_required(Permission.MODERATE)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">for_moderators_only</span><span class="params">()</span></span><span class="symbol">:</span></span><br><span class="line">	<span class="keyword">return</span> <span class="string">&quot;For comment moderators&quot;</span></span><br></pre></td></tr></table></figure>

<p>在模板中可能也需要检查权限，所以Permission类的所有常量要能在模板中访问，为了避免每次都调用 render_template 时多添加一个参数，可以使用上下文处理器。在渲染时，上下文处理器能让变量在所有模板中可访问，<code>app/main/__init__.py</code>：</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">@main.app_context_processor</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">inject_permissions</span><span class="params">()</span></span><span class="symbol">:</span></span><br><span class="line">	<span class="keyword">return</span> dict(Permission=Permission)</span><br></pre></td></tr></table></figure>

<p>编写角色和权限的测试，<code>tests/test_user_model.py</code>：</p>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="constructor">UserModelTestCase(<span class="params">unittest</span>.TestCase)</span>:</span><br><span class="line">	# ...</span><br><span class="line">	def test<span class="constructor">_user_role(<span class="params">self</span>)</span>:</span><br><span class="line">		u = <span class="constructor">User(<span class="params">email</span>=&#x27;<span class="params">john</span>@<span class="params">example</span>.<span class="params">com</span>&#x27;, <span class="params">password</span>=&#x27;<span class="params">cat</span>&#x27;)</span></span><br><span class="line">		self.<span class="keyword">assert</span><span class="constructor">True(<span class="params">u</span>.<span class="params">can</span>(Permission.FOLLOW)</span>)</span><br><span class="line">		self.<span class="keyword">assert</span><span class="constructor">True(<span class="params">u</span>.<span class="params">can</span>(Permission.COMMENT)</span>)</span><br><span class="line">		self.<span class="keyword">assert</span><span class="constructor">True(<span class="params">u</span>.<span class="params">can</span>(Permission.WRITE)</span>)</span><br><span class="line">		self.<span class="keyword">assert</span><span class="constructor">False(<span class="params">u</span>.<span class="params">can</span>(Permission.MODERATE)</span>)</span><br><span class="line">		self.<span class="keyword">assert</span><span class="constructor">False(<span class="params">u</span>.<span class="params">can</span>(Permission.ADMIN)</span>)</span><br><span class="line">	def test<span class="constructor">_anonymous_user(<span class="params">self</span>)</span>:</span><br><span class="line">		u = <span class="constructor">AnonymousUser()</span></span><br><span class="line">		self.<span class="keyword">assert</span><span class="constructor">False(<span class="params">u</span>.<span class="params">can</span>(Permission.FOLLOW)</span>)</span><br><span class="line">		self.<span class="keyword">assert</span><span class="constructor">False(<span class="params">u</span>.<span class="params">can</span>(Permission.COMMENT)</span>)</span><br><span class="line">		self.<span class="keyword">assert</span><span class="constructor">False(<span class="params">u</span>.<span class="params">can</span>(Permission.WRITE)</span>)</span><br><span class="line">		self.<span class="keyword">assert</span><span class="constructor">False(<span class="params">u</span>.<span class="params">can</span>(Permission.MODERATE)</span>)</span><br><span class="line">		self.<span class="keyword">assert</span><span class="constructor">False(<span class="params">u</span>.<span class="params">can</span>(Permission.ADMIN)</span>)</span><br></pre></td></tr></table></figure>

<p>先在 shell 会话中添加这些新角色到开发数据库</p>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">flask shell</span><br><span class="line"><span class="module-access"><span class="module"><span class="identifier">Role</span>.</span></span>insert<span class="constructor">_roles()</span></span><br><span class="line"><span class="module-access"><span class="module"><span class="identifier">Role</span>.</span></span>query.all<span class="literal">()</span></span><br></pre></td></tr></table></figure>

<p>最好更新用户列表，为在此之前创建的用户账户分配用户角色</p>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">flask shell</span><br><span class="line">admin_role = <span class="module-access"><span class="module"><span class="identifier">Role</span>.</span></span>query.filter<span class="constructor">_by(<span class="params">name</span>=&#x27;Administrator&#x27;)</span>.first<span class="literal">()</span></span><br><span class="line">default_role = <span class="module-access"><span class="module"><span class="identifier">Role</span>.</span></span>query.filter<span class="constructor">_by(<span class="params">default</span>=True)</span>.first<span class="literal">()</span></span><br><span class="line"><span class="keyword">for</span> u <span class="keyword">in</span> <span class="module-access"><span class="module"><span class="identifier">User</span>.</span></span>query.all<span class="literal">()</span>:</span><br><span class="line">	<span class="keyword">if</span> u.email<span class="operator"> == </span>app.config<span class="literal">[&#x27;FLASKY<span class="identifier">_ADMIN</span>&#x27;]</span>:</span><br><span class="line">		u.role = admin_role</span><br><span class="line">	<span class="keyword">else</span>:</span><br><span class="line">		u.role = default_role</span><br><span class="line">db.session.commit<span class="literal">()</span></span><br></pre></td></tr></table></figure>

<h2 id="用户资料"><a href="#用户资料" class="headerlink" title="用户资料"></a>用户资料</h2><h3 id="资料信息"><a href="#资料信息" class="headerlink" title="资料信息"></a>资料信息</h3><p>在数据库中存储一些额外信息用于站视，扩充 User模型，<code>app/models.py</code>：</p>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="constructor">User(UserMixin, <span class="params">db</span>.Model)</span>:</span><br><span class="line">	# ...</span><br><span class="line">	name = db.<span class="constructor">Column(<span class="params">db</span>.String(64)</span>)</span><br><span class="line">	location = db.<span class="constructor">Column(<span class="params">db</span>.String(64)</span>)</span><br><span class="line">	about_me = db.<span class="constructor">Column(<span class="params">db</span>.Text()</span>)</span><br><span class="line">	member_since = db.<span class="constructor">Column(<span class="params">db</span>.DateTime()</span>, default=datatime.utcnow)</span><br><span class="line">	last_seen = db.<span class="constructor">Column(<span class="params">db</span>.<span class="params">dateTime</span>()</span>, default=datetime.utcnow)</span><br></pre></td></tr></table></figure>

<p><code>db.Column</code>的default参数可以接受函数作为参数，每次需要生成默认值，SQLAlchemy都会调用指定的函数。<code>member_since</code>只需要使用一次默认值，而<code>last_seen</code>每次用户访问后都需要刷新，可以在User类中添加一个方法执行这个操作，<code>app/models.py</code>：</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span>(<span class="title">UserMixin</span>, <span class="title">db</span>.<span class="title">Model</span>):</span></span><br><span class="line">	<span class="comment"># ...</span></span><br><span class="line">	<span class="function"><span class="keyword">def</span> <span class="title">ping</span><span class="params">(<span class="keyword">self</span>)</span></span><span class="symbol">:</span></span><br><span class="line">		<span class="keyword">self</span>.last_seen = datetime.utcnow()</span><br><span class="line">		db.session.add(<span class="keyword">self</span>)</span><br><span class="line">		db.session.commit()</span><br></pre></td></tr></table></figure>

<p>每次收到用户请求都要调用这个 ping 方法，可以使用 auth 蓝本中的 <code>before_app_request</code> 处理程序，<code>app/auth/views.py</code>：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"></span><br></pre></td></tr></table></figure>

</div><div class="article-licensing box"><div class="licensing-title"><p>flask 开发</p><p><a href="http://example.com/2019/11/23/flask/">http://example.com/2019/11/23/flask/</a></p></div><div class="licensing-meta level is-mobile"><div class="level-left"><div class="level-item is-narrow"><div><h6>作者</h6><p>lll</p></div></div><div class="level-item is-narrow"><div><h6>发布于</h6><p>2019-11-23</p></div></div><div class="level-item is-narrow"><div><h6>更新于</h6><p>2020-07-07</p></div></div><div class="level-item is-narrow"><div><h6>许可协议</h6><p><a class="icon" rel="noopener" target="_blank" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a><a class="icon" rel="noopener" target="_blank" title="Attribution" href="https://creativecommons.org/licenses/by/4.0/"><i class="fab fa-creative-commons-by"></i></a><a class="icon" rel="noopener" target="_blank" title="Noncommercial" href="https://creativecommons.org/licenses/by-nc/4.0/"><i class="fab fa-creative-commons-nc"></i></a></p></div></div></div></div></div><div class="article-tags is-size-7 mb-4"><span class="mr-2">#</span><a class="link-muted mr-2" rel="tag" href="/tags/flask/">flask</a><a class="link-muted mr-2" rel="tag" href="/tags/python/">python</a></div><!--!--></article></div><!--!--><nav class="post-navigation mt-4 level is-mobile"><div class="level-start"><a class="article-nav-prev level level-item link-muted" href="/2019/11/27/md5-0e/"><i class="level-item fas fa-chevron-left"></i><span class="level-item">MD5后以0e开头的字符串</span></a></div><div class="level-end"><a class="article-nav-next level level-item link-muted" href="/2019/10/11/kalinethunter/"><span class="level-item">kalinethunter</span><i class="level-item fas fa-chevron-right"></i></a></div></nav><!--!--></div><div class="column column-left is-4-tablet is-4-desktop is-4-widescreen  order-1"><div class="card widget" data-type="profile"><div class="card-content"><nav class="level"><div class="level-item has-text-centered flex-shrink-1"><div><figure class="image is-128x128 mx-auto mb-2"><img class="avatar" src="/img/avatar.png" alt="lll"></figure><p class="title is-size-4 is-block" style="line-height:inherit;">lll</p></div></div></nav><nav class="level is-mobile"><div class="level-item has-text-centered is-marginless"><div><p class="heading">文章</p><a href="/archives"><p class="title">42</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">分类</p><a href="/categories"><p class="title">8</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">标签</p><a href="/tags"><p class="title">13</p></a></div></div></nav><div class="level"><a class="level-item button is-primary is-rounded" href="https://github.com/1klnd" target="_blank" rel="noopener">关注我</a></div></div></div><div class="card widget" id="toc" data-type="toc"><div class="card-content"><div class="menu"><h3 class="menu-label">目录</h3><ul class="menu-list"><li><a class="level is-mobile" href="#Flask-简介"><span class="level-left"><span class="level-item">1</span><span class="level-item">Flask 简介</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#准备"><span class="level-left"><span class="level-item">1.1</span><span class="level-item">准备</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#创建应用目录"><span class="level-left"><span class="level-item">1.1.1</span><span class="level-item">创建应用目录</span></span></a></li><li><a class="level is-mobile" href="#准备虚拟环境"><span class="level-left"><span class="level-item">1.1.2</span><span class="level-item">准备虚拟环境</span></span></a></li><li><a class="level is-mobile" href="#安装-flask"><span class="level-left"><span class="level-item">1.1.3</span><span class="level-item">安装 flask</span></span></a></li></ul></li><li><a class="level is-mobile" href="#应用的基本结构"><span class="level-left"><span class="level-item">1.2</span><span class="level-item">应用的基本结构</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#初始化"><span class="level-left"><span class="level-item">1.2.1</span><span class="level-item">初始化</span></span></a></li><li><a class="level is-mobile" href="#路由和视图函数"><span class="level-left"><span class="level-item">1.2.2</span><span class="level-item">路由和视图函数</span></span></a></li><li><a class="level is-mobile" href="#完整应用实例"><span class="level-left"><span class="level-item">1.2.3</span><span class="level-item">完整应用实例</span></span></a></li><li><a class="level is-mobile" href="#Web开发服务器"><span class="level-left"><span class="level-item">1.2.4</span><span class="level-item">Web开发服务器</span></span></a></li><li><a class="level is-mobile" href="#调试模式"><span class="level-left"><span class="level-item">1.2.5</span><span class="level-item">调试模式</span></span></a></li><li><a class="level is-mobile" href="#命令行选项"><span class="level-left"><span class="level-item">1.2.6</span><span class="level-item">命令行选项</span></span></a></li><li><a class="level is-mobile" href="#请求-响应循环"><span class="level-left"><span class="level-item">1.2.7</span><span class="level-item">请求-响应循环</span></span></a></li><li><a class="level is-mobile" href="#Flask-扩展"><span class="level-left"><span class="level-item">1.2.8</span><span class="level-item">Flask 扩展</span></span></a></li></ul></li><li><a class="level is-mobile" href="#模板"><span class="level-left"><span class="level-item">1.3</span><span class="level-item">模板</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#Jinja2-模板引擎"><span class="level-left"><span class="level-item">1.3.1</span><span class="level-item">Jinja2 模板引擎</span></span></a></li><li><a class="level is-mobile" href="#使用Flask-Bootstrap集成Bootstrap"><span class="level-left"><span class="level-item">1.3.2</span><span class="level-item">使用Flask-Bootstrap集成Bootstrap</span></span></a></li><li><a class="level is-mobile" href="#自定义错误界面"><span class="level-left"><span class="level-item">1.3.3</span><span class="level-item">自定义错误界面</span></span></a></li><li><a class="level is-mobile" href="#链接"><span class="level-left"><span class="level-item">1.3.4</span><span class="level-item">链接</span></span></a></li><li><a class="level is-mobile" href="#静态文件"><span class="level-left"><span class="level-item">1.3.5</span><span class="level-item">静态文件</span></span></a></li><li><a class="level is-mobile" href="#使用Flask-Moment本地化日期和时间"><span class="level-left"><span class="level-item">1.3.6</span><span class="level-item">使用Flask-Moment本地化日期和时间</span></span></a></li></ul></li><li><a class="level is-mobile" href="#表单"><span class="level-left"><span class="level-item">1.4</span><span class="level-item">表单</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#配置"><span class="level-left"><span class="level-item">1.4.1</span><span class="level-item">配置</span></span></a></li><li><a class="level is-mobile" href="#表单类"><span class="level-left"><span class="level-item">1.4.2</span><span class="level-item">表单类</span></span></a></li><li><a class="level is-mobile" href="#渲染表单"><span class="level-left"><span class="level-item">1.4.3</span><span class="level-item">渲染表单</span></span></a></li><li><a class="level is-mobile" href="#在视图函数中处理表单"><span class="level-left"><span class="level-item">1.4.4</span><span class="level-item">在视图函数中处理表单</span></span></a></li><li><a class="level is-mobile" href="#重定向和用户会话"><span class="level-left"><span class="level-item">1.4.5</span><span class="level-item">重定向和用户会话</span></span></a></li><li><a class="level is-mobile" href="#闪现消息"><span class="level-left"><span class="level-item">1.4.6</span><span class="level-item">闪现消息</span></span></a></li></ul></li><li><a class="level is-mobile" href="#数据库"><span class="level-left"><span class="level-item">1.5</span><span class="level-item">数据库</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#SQL数据库"><span class="level-left"><span class="level-item">1.5.1</span><span class="level-item">SQL数据库</span></span></a></li><li><a class="level is-mobile" href="#NoSQL数据库"><span class="level-left"><span class="level-item">1.5.2</span><span class="level-item">NoSQL数据库</span></span></a></li><li><a class="level is-mobile" href="#Python数据库框架"><span class="level-left"><span class="level-item">1.5.3</span><span class="level-item">Python数据库框架</span></span></a></li><li><a class="level is-mobile" href="#使用-Flask-SQLAlchemy管理数据"><span class="level-left"><span class="level-item">1.5.4</span><span class="level-item">使用 Flask-SQLAlchemy管理数据</span></span></a></li><li><a class="level is-mobile" href="#定义模型"><span class="level-left"><span class="level-item">1.5.5</span><span class="level-item">定义模型</span></span></a></li><li><a class="level is-mobile" href="#关系"><span class="level-left"><span class="level-item">1.5.6</span><span class="level-item">关系</span></span></a></li><li><a class="level is-mobile" href="#数据库操作"><span class="level-left"><span class="level-item">1.5.7</span><span class="level-item">数据库操作</span></span></a></li><li><a class="level is-mobile" href="#在视图函数中操作数据库"><span class="level-left"><span class="level-item">1.5.8</span><span class="level-item">在视图函数中操作数据库</span></span></a></li><li><a class="level is-mobile" href="#集成python-shell"><span class="level-left"><span class="level-item">1.5.9</span><span class="level-item">集成python shell</span></span></a></li><li><a class="level is-mobile" href="#使用Flask-Migrate实现数据库迁移"><span class="level-left"><span class="level-item">1.5.10</span><span class="level-item">使用Flask-Migrate实现数据库迁移</span></span></a></li></ul></li><li><a class="level is-mobile" href="#电子邮件"><span class="level-left"><span class="level-item">1.6</span><span class="level-item">电子邮件</span></span></a></li><li><a class="level is-mobile" href="#大型应用的结构"><span class="level-left"><span class="level-item">1.7</span><span class="level-item">大型应用的结构</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#项目结构"><span class="level-left"><span class="level-item">1.7.1</span><span class="level-item">项目结构</span></span></a></li><li><a class="level is-mobile" href="#配置选项"><span class="level-left"><span class="level-item">1.7.2</span><span class="level-item">配置选项</span></span></a></li><li><a class="level is-mobile" href="#应用包"><span class="level-left"><span class="level-item">1.7.3</span><span class="level-item">应用包</span></span></a></li><li><a class="level is-mobile" href="#应用脚本"><span class="level-left"><span class="level-item">1.7.4</span><span class="level-item">应用脚本</span></span></a></li><li><a class="level is-mobile" href="#需求文件"><span class="level-left"><span class="level-item">1.7.5</span><span class="level-item">需求文件</span></span></a></li><li><a class="level is-mobile" href="#单元测试"><span class="level-left"><span class="level-item">1.7.6</span><span class="level-item">单元测试</span></span></a></li><li><a class="level is-mobile" href="#创建数据库"><span class="level-left"><span class="level-item">1.7.7</span><span class="level-item">创建数据库</span></span></a></li><li><a class="level is-mobile" href="#运行应用"><span class="level-left"><span class="level-item">1.7.8</span><span class="level-item">运行应用</span></span></a></li></ul></li></ul></li><li><a class="level is-mobile" href="#实例：社交博客应用"><span class="level-left"><span class="level-item">2</span><span class="level-item">实例：社交博客应用</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#用户身份认证"><span class="level-left"><span class="level-item">2.1</span><span class="level-item">用户身份认证</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#密码安全性"><span class="level-left"><span class="level-item">2.1.1</span><span class="level-item">密码安全性</span></span></a></li><li><a class="level is-mobile" href="#创建身份验证蓝本"><span class="level-left"><span class="level-item">2.1.2</span><span class="level-item">创建身份验证蓝本</span></span></a></li><li><a class="level is-mobile" href="#使用-Flask-Login-验证身份"><span class="level-left"><span class="level-item">2.1.3</span><span class="level-item">使用 Flask-Login 验证身份</span></span></a></li><li><a class="level is-mobile" href="#注册新用户"><span class="level-left"><span class="level-item">2.1.4</span><span class="level-item">注册新用户</span></span></a></li><li><a class="level is-mobile" href="#确认账户"><span class="level-left"><span class="level-item">2.1.5</span><span class="level-item">确认账户</span></span></a></li><li><a class="level is-mobile" href="#管理账户"><span class="level-left"><span class="level-item">2.1.6</span><span class="level-item">管理账户</span></span></a></li></ul></li><li><a class="level is-mobile" href="#用户角色"><span class="level-left"><span class="level-item">2.2</span><span class="level-item">用户角色</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#角色在数据库中的表示"><span class="level-left"><span class="level-item">2.2.1</span><span class="level-item">角色在数据库中的表示</span></span></a></li><li><a class="level is-mobile" href="#赋予角色"><span class="level-left"><span class="level-item">2.2.2</span><span class="level-item">赋予角色</span></span></a></li><li><a class="level is-mobile" href="#检验角色"><span class="level-left"><span class="level-item">2.2.3</span><span class="level-item">检验角色</span></span></a></li></ul></li><li><a class="level is-mobile" href="#用户资料"><span class="level-left"><span class="level-item">2.3</span><span class="level-item">用户资料</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#资料信息"><span class="level-left"><span class="level-item">2.3.1</span><span class="level-item">资料信息</span></span></a></li></ul></li></ul></li></ul></div></div><style>.menu-list > li > a.is-active + .menu-list { display: block; }.menu-list > li > a + .menu-list { display: none; }</style><script src="/js/toc.js" defer></script></div><div class="card widget" data-type="categories"><div class="card-content"><div class="menu"><h3 class="menu-label">分类</h3><ul class="menu-list"><li><a class="level is-mobile" href="/categories/AI/"><span class="level-start"><span class="level-item">AI</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/CTF/"><span class="level-start"><span class="level-item">CTF</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/Powershell/"><span class="level-start"><span class="level-item">Powershell</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/metasploit/"><span class="level-start"><span class="level-item">metasploit</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/notes/"><span class="level-start"><span class="level-item">notes</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/python/"><span class="level-start"><span class="level-item">python</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/vulnhub/"><span class="level-start"><span class="level-item">vulnhub</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/categories/%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/"><span class="level-start"><span class="level-item">漏洞复现</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li></ul></div></div></div><div class="card widget" data-type="recent-posts"><div class="card-content"><h3 class="menu-label">最新文章</h3><article class="media"><div class="media-content"><p class="date"><time dateTime="2020-10-04T08:35:56.000Z">2020-10-04</time></p><p class="title"><a href="/2020/10/04/java/">Java 笔记</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2020-10-03T07:52:45.000Z">2020-10-03</time></p><p class="title"><a href="/2020/10/03/gopher/">Gopher 协议利用</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2020-08-21T02:09:13.000Z">2020-08-21</time></p><p class="title"><a href="/2020/08/21/node-js/">Node.js 相关</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2020-08-06T02:02:51.000Z">2020-08-06</time></p><p class="title"><a href="/2020/08/06/docker/">Docker</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2020-08-04T07:40:44.000Z">2020-08-04</time></p><p class="title"><a href="/2020/08/04/network/">计算机网络</a></p></div></article></div></div><div class="card widget" data-type="archives"><div class="card-content"><div class="menu"><h3 class="menu-label">归档</h3><ul class="menu-list"><li><a class="level is-mobile" href="/archives/2020/10/"><span class="level-start"><span class="level-item">十月 2020</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/08/"><span class="level-start"><span class="level-item">八月 2020</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/07/"><span class="level-start"><span class="level-item">七月 2020</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/06/"><span class="level-start"><span class="level-item">六月 2020</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/05/"><span class="level-start"><span class="level-item">五月 2020</span></span><span class="level-end"><span class="level-item tag">6</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/04/"><span class="level-start"><span class="level-item">四月 2020</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/03/"><span class="level-start"><span class="level-item">三月 2020</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/02/"><span class="level-start"><span class="level-item">二月 2020</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/01/"><span class="level-start"><span class="level-item">一月 2020</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li><li><a class="level is-mobile" href="/archives/2019/11/"><span class="level-start"><span class="level-item">十一月 2019</span></span><span class="level-end"><span class="level-item tag">6</span></span></a></li><li><a class="level is-mobile" href="/archives/2019/10/"><span class="level-start"><span class="level-item">十月 2019</span></span><span class="level-end"><span class="level-item tag">7</span></span></a></li><li><a class="level is-mobile" href="/archives/2019/09/"><span class="level-start"><span class="level-item">九月 2019</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li></ul></div></div></div><div class="card widget" data-type="tags"><div class="card-content"><div class="menu"><h3 class="menu-label">标签</h3><div class="field is-grouped is-grouped-multiline"><div class="control"><a class="tags has-addons" href="/tags/AI/"><span class="tag">AI</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/CTF/"><span class="tag">CTF</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Powershell/"><span class="tag">Powershell</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Writeup/"><span class="tag">Writeup</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/flask/"><span class="tag">flask</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/metasploit/"><span class="tag">metasploit</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/python/"><span class="tag">python</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/shell/"><span class="tag">shell</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/ssr/"><span class="tag">ssr</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/tables/"><span class="tag">tables</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/tricks/"><span class="tag">tricks</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/vulnhub/"><span class="tag">vulnhub</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/"><span class="tag">渗透测试</span><span class="tag">3</span></a></div></div></div></div></div></div><!--!--></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/"><img src="/img/logo.svg" alt="饱食终日，无所事事" height="28"></a><p class="is-size-7"><span>&copy; 2020 lll</span>  Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a></p></div><div class="level-end"></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" async></script><script>moment.locale("zh-CN");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script src="/js/column.js"></script><script src="/js/animation.js"></script><a id="back-to-top" title="回到顶端" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/js/back_to_top.js" defer></script><script src="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.js" defer></script><script>window.addEventListener("load", () => {
      window.cookieconsent.initialise({
        type: "info",
        theme: "edgeless",
        static: false,
        position: "bottom-left",
        content: {
          message: "此网站使用Cookie来改善您的体验。",
          dismiss: "知道了！",
          allow: "允许使用Cookie",
          deny: "拒绝",
          link: "了解更多",
          policy: "Cookie政策",
          href: "https://www.cookiesandyou.com/",
        },
        palette: {
          popup: {
            background: "#edeff5",
            text: "#838391"
          },
          button: {
            background: "#4b81e8"
          },
        },
      });
    });</script><script src="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/js/lightgallery.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><!--!--><!--!--><!--!--><script src="/js/main.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="想要查找什么..."></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div></div></div><script src="/js/insight.js" defer></script><script>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/content.json"}, {"hint":"想要查找什么...","untitled":"(无标题)","posts":"文章","pages":"页面","categories":"分类","tags":"标签"});
        });</script></body></html>